# 系统本金功能说明

## 📌 功能概述

系统本金是一个独立的财务概念，用于记录和管理系统的总资本（以港币为单位）。与日常的人民币/港币余额调整不同，**系统本金专门用于利润累积和资本管理**。

## 💡 核心概念

### 什么是系统本金？

- **单一金额**：只有一个数值，单位为港币（HKD）
- **利润累积**：每次结算后，利润自动加到本金上
- **公式**：`新本金 = 旧本金 + 利润 - 其他支出`
- **独立管理**：与各渠道的人民币/港币余额分开管理

### 与余额调整的区别

| 项目 | 系统本金 | 余额调整 |
|------|---------|---------|
| 单位 | 港币（HKD） | 人民币或港币 |
| 用途 | 资本管理、利润累积 | 各渠道日常余额校正 |
| 调整方式 | 手动调整 + 结算自动更新 | 仅手动调整 |
| 记录类型 | 手动、结算、系统 | 手动、系统 |

## 🎯 功能特性

### 1. 本金管理页面

**位置**：后台管理系统 → 财务管理 → 系统本金

**功能**：
- ✅ 查看当前系统本金
- ✅ 查看本金调整历史
- ✅ 手动调整本金
- ✅ 查看结算触发的本金变化

### 2. 本金调整记录

每次本金变化都会记录：
- 调整前本金
- 调整金额
- 调整后本金
- 调整类型（手动/结算/系统）
- 关联结算（如果是结算触发）
- 操作人
- 调整原因
- 调整时间

### 3. 结算自动更新

每次执行结算操作时，系统会：
1. 计算本次利润
2. 扣除其他支出
3. 自动创建本金调整记录
4. 更新系统本金

**公式**：
```
新本金 = 当前本金 + 本次利润 - 其他支出
```

## 📋 使用指南

### 初始化系统本金

1. 登录后台管理系统
2. 进入 **财务管理 → 系统本金**
3. 点击 **"调整本金"** 按钮
4. 输入初始本金金额（港币）
5. 调整原因填写："初始化系统本金"
6. 保存

### 手动调整本金

**适用场景**：
- 初始化系统本金
- 增资/减资
- 本金校正
- 资本重组

**操作步骤**：
1. 进入 **财务管理 → 系统本金**
2. 点击 **"调整本金"**
3. 填写调整信息：
   - 当前本金（自动显示）
   - 调整后本金（输入新金额）
   - 调整金额（自动计算）
   - 调整类型（选择"手动调整"或"系统调整"）
   - 调整原因（必填）
4. 保存

### 查看本金历史

1. 进入 **财务管理 → 系统本金**
2. 表格中显示所有本金调整记录
3. 可以按调整类型筛选
4. 点击记录可查看详情

### 结算时的本金更新

执行结算操作时，系统会自动：
1. 获取当前本金
2. 计算本次利润
3. 扣除其他支出（如有）
4. 创建"结算调整"类型的本金记录
5. 更新本金到新值

**示例**：
```
当前本金：100,000 HKD
本次利润：5,000 HKD
其他支出：500 HKD
新本金 = 100,000 + 5,000 - 500 = 104,500 HKD
```

## 🔒 权限控制

### 查看权限
- ✅ 管理员（Admin）
- ✅ 财务人员（Finance）
- ✅ 外勤人员（Field User）- 只读

### 调整权限
- ✅ 管理员（Admin）
- ✅ 财务人员（Finance）
- ❌ 外勤人员（Field User）

### 其他限制
- ❌ 本金调整记录不可编辑
- ❌ 本金调整记录不可删除
- ✅ 所有调整都有完整的审计追踪

## 📊 数据结构

### capital_adjustments 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | bigint | 主键 |
| before_amount | decimal(15,2) | 调整前本金 |
| after_amount | decimal(15,2) | 调整后本金 |
| adjustment_amount | decimal(15,2) | 调整金额 |
| adjustment_type | enum | 调整类型：manual/settlement/system |
| settlement_id | bigint | 关联结算ID（可选） |
| user_id | bigint | 操作人ID |
| reason | text | 调整原因 |
| created_at | timestamp | 调整时间 |

## 🔧 技术实现

### 核心文件

1. **模型**：`app/Models/CapitalAdjustment.php`
   - 本金调整数据模型
   - 提供 `getCurrentCapital()` 方法获取当前本金
   - 提供 `createAdjustment()` 方法创建调整记录

2. **资源**：`app/Filament/Resources/CapitalAdjustmentResource.php`
   - Filament 后台管理资源
   - 定义表单、表格、页面

3. **服务**：`app/Services/SettlementService.php`
   - 集成本金更新逻辑
   - 结算时自动创建本金调整记录

4. **迁移**：`database/migrations/2025_10_27_142942_create_capital_adjustments_table.php`
   - 创建本金调整表结构

### API 方法

```php
// 获取当前系统本金
$currentCapital = CapitalAdjustment::getCurrentCapital();

// 创建本金调整记录
CapitalAdjustment::createAdjustment(
    $newAmount,      // 新的本金金额
    $type,           // 调整类型：manual/settlement/system
    $reason,         // 调整原因
    $settlementId,   // 关联结算ID（可选）
    $userId          // 操作人ID（可选，默认当前用户）
);
```

## 📈 报表与统计

### 在列表页面显示
- 💰 当前系统本金（页面顶部醒目显示）
- 📊 按时间倒序排列的所有调整记录
- 🔍 可按调整类型筛选

### 在结算详情中
- 关联显示对应的本金调整记录
- 展示利润如何影响本金变化

## ⚠️ 注意事项

1. **初始化**：首次使用前需要手动设置初始本金
2. **只读历史**：所有本金调整记录都是只读的，不可修改或删除
3. **结算自动更新**：执行结算时会自动更新本金，无需手动操作
4. **单位统一**：系统本金始终以港币为单位
5. **审计追踪**：每次调整都有完整的记录，便于审计

## 🚀 部署说明

### 1. 运行迁移
```bash
cd backend
php artisan migrate
```

### 2. 更新系统设置（可选）
如果数据库中没有 `system_capital_hkd` 设置项，可以手动添加：
```bash
php artisan db:seed --class=SettingSeeder
```

### 3. 清除缓存
```bash
php artisan cache:clear
php artisan config:clear
```

### 4. 重启服务
重启 PHP 服务器以加载新代码

## 📞 支持

如有问题，请联系系统管理员或技术支持团队。

