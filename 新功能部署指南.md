# 结余功能新增特性部署指南

## 📋 部署前准备

### 环境要求

**后端环境**：
- PHP >= 8.0 (推荐 8.1 或 8.2，8.4可能有兼容性问题)
- Composer
- PHP扩展：
  - `fileinfo`
  - `zip`
  - `pdo_sqlite` 或 `pdo_mysql`
  - `mbstring`
  - `openssl`

**前端环境**：
- Node.js >= 16.0
- npm 或 yarn

### 检查环境

```bash
# 检查PHP版本和扩展
php -v
php -m | grep -E "fileinfo|zip|pdo"

# 检查Composer
composer -V

# 检查Node.js
node -v
npm -v
```

---

## 🚀 部署步骤

### 步骤1: 后端数据库迁移

#### 方式A: 使用 Laravel Artisan（推荐）

```bash
# 1. 进入后端目录
cd CurrencyExSystem/ExchangeSystem/backend

# 2. 确保依赖已安装
composer install --no-dev --ignore-platform-reqs

# 3. 执行迁移
php artisan migrate

# 4. 验证迁移
php artisan migrate:status
```

#### 方式B: 直接执行SQL（如果Artisan无法使用）

在数据库中直接执行以下SQL：

```sql
-- ========================================
-- 迁移 1: 添加结余日期和用户字段
-- ========================================
ALTER TABLE settlements 
ADD COLUMN settlement_date DATE NOT NULL COMMENT '结余日期(YYYY-MM-DD)' AFTER id;

ALTER TABLE settlements 
ADD COLUMN created_by BIGINT UNSIGNED NULL COMMENT '执行结余的用户ID' AFTER notes;

-- 添加唯一索引（确保每天最多一条记录）
ALTER TABLE settlements 
ADD UNIQUE INDEX unique_settlement_date (settlement_date);

-- ========================================
-- 迁移 2: 添加结余确认密码
-- ========================================
INSERT INTO settings (key_name, key_value, description, type, created_at, updated_at)
VALUES (
    'settlement_password', 
    -- 默认密码 123456 的哈希值
    '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 
    '结余确认密码（用于二次验证）', 
    'password', 
    NOW(), 
    NOW()
);

-- ========================================
-- 迁移 3: 添加利润明细字段
-- ========================================
ALTER TABLE settlements
ADD COLUMN outgoing_profit DECIMAL(15,3) DEFAULT 0 NOT NULL COMMENT '出账利润(HKD)' AFTER profit;

ALTER TABLE settlements
ADD COLUMN instant_profit DECIMAL(15,3) DEFAULT 0 NOT NULL COMMENT '即时买断利润(HKD)' AFTER outgoing_profit;

ALTER TABLE settlements
ADD COLUMN instant_buyout_rate DECIMAL(10,5) NULL COMMENT '即时买断汇率(CNY/HKD)' AFTER instant_profit;
```

### 步骤2: 验证数据库更新

```sql
-- 查看 settlements 表结构
DESC settlements;

-- 应该包含以下新字段:
-- settlement_date (date, unique)
-- outgoing_profit (decimal)
-- instant_profit (decimal)  
-- instant_buyout_rate (decimal)
-- created_by (bigint)

-- 查看唯一索引
SHOW INDEX FROM settlements WHERE Key_name = 'unique_settlement_date';

-- 查看结余密码配置
SELECT * FROM settings WHERE key_name = 'settlement_password';
```

### 步骤3: 清除缓存

```bash
cd backend

php artisan cache:clear
php artisan config:clear
php artisan route:clear
php artisan view:clear
```

### 步骤4: 前端构建

```bash
# 1. 进入前端目录
cd ../frontend

# 2. 安装依赖（如有新增）
npm install

# 3. 开发环境测试
npm run dev

# 4. 生产环境构建
npm run build
```

---

## 🔍 功能验证

### 1. 测试API端点

使用 Postman 或 curl 测试：

```bash
# 检查今日是否已结余
curl -X GET http://localhost:8000/api/settlements/check-today \
  -H "Authorization: Bearer YOUR_TOKEN"

# 获取结余预览
curl -X GET http://localhost:8000/api/settlements/preview \
  -H "Authorization: Bearer YOUR_TOKEN"

# 验证密码 (默认: 123456)
curl -X POST http://localhost:8000/api/settlements/verify-password \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"password": "123456"}'
```

### 2. 测试前端页面

访问以下页面验证功能：

- `/settlements` - 结余记录列表
- `/settlement/preview` - 结余预览页面
- `/settlements/1` - 结余详情页面（需要有数据）

### 3. 完整流程测试

1. ✅ 访问结余预览页面
2. ✅ 检查是否显示"今日已结余"警告（第二次访问时）
3. ✅ 核对数据正确显示（原本金、人民币结余、利润、新本金）
4. ✅ 添加其他支出
5. ✅ 点击"确认结余"
6. ✅ 输入密码 `123456`
7. ✅ 验证结余成功
8. ✅ 查看结余详情
9. ✅ 在结余列表中看到新记录

---

## ⚙️ 配置说明

### 修改默认密码（重要！）

**方式A: 使用Tinker**
```bash
php artisan tinker

>>> \App\Models\Setting::set('settlement_password', password_hash('新密码', PASSWORD_DEFAULT), '结余确认密码', 'password');
>>> exit
```

**方式B: 直接执行SQL**
```sql
UPDATE settings 
SET key_value = '$2y$10$YOUR_NEW_PASSWORD_HASH' 
WHERE key_name = 'settlement_password';
```

**生成新密码哈希**：
```php
<?php
echo password_hash('你的新密码', PASSWORD_DEFAULT);
?>
```

---

## 📁 更新文件清单

### 后端文件

**新增迁移文件**：
```
backend/database/migrations/
├── 2025_10_24_000001_update_settlements_add_date_fields.php
├── 2025_10_24_000002_add_settlement_password_to_settings.php
└── 2025_10_24_000003_add_profit_breakdown_to_settlements.php
```

**修改的文件**：
```
backend/app/Models/Settlement.php
backend/app/Services/SettlementService.php
backend/app/Http/Controllers/Api/SettlementController.php
backend/routes/api.php
```

### 前端文件

**新增页面**：
```
frontend/src/pages/
├── SettlementPreviewPage.vue
├── SettlementDetailPage.vue
└── SettlementListPage.vue
```

**修改的文件**：
```
frontend/src/router/index.js
```

---

## 🎯 核心功能说明

### 1. 每天一次限制

**实现机制**：
- 数据库唯一索引：`settlement_date`
- 前端检查：进入预览页面时检查
- 后端验证：执行结余时再次验证

**用户体验**：
- 首次结余：正常流程
- 重复结余：显示警告 + 查看详情按钮

### 2. 密码验证

**默认密码**：`123456`

**验证流程**：
1. 用户填写完结余信息
2. 点击"确认结余"
3. 弹出密码输入框
4. 输入密码
5. 后端验证
6. 通过则执行结余

**安全性**：
- 密码使用 `password_hash()` 加密存储
- 使用 `password_verify()` 验证
- 传输时可能需要HTTPS

### 3. 结余预览

**核对数据**（醒目显示）：
- ✓ 原本金（上次结余后）
- ✓ 人民币结余
- ✓ 利润（本次结余）
- ✓ 新本金（本次结余后）

**详细计算**（可展开）：
- 出账利润
- 即时买断利润
- 总利润
- 结余汇率
- 即时买断汇率（如有）

### 4. 即时买断支持

**特点**：
- 需要输入即时买断汇率
- 利润单独计算
- 港币卖出金额四舍五入到十位

**计算公式**：
```
即时买断利润 = 港币卖出金额 - 港币成本
港币卖出金额 = 人民币总额 ÷ 即时买断汇率（四舍五入到十位）
```

---

## 🔧 故障排查

### 问题1: 迁移失败 - 字段已存在

**错误**：`Duplicate column name 'settlement_date'`

**原因**：字段已经存在

**解决**：
```sql
-- 检查字段是否存在
DESC settlements;

-- 如果已存在，跳过该迁移
```

### 问题2: 唯一索引冲突

**错误**：`Duplicate entry '2025-10-24' for key 'unique_settlement_date'`

**原因**：当天已有结余记录

**解决**：这是正常行为，每天只能结余一次

### 问题3: 密码验证一直失败

**原因**：密码哈希不匹配

**解决**：
```bash
php artisan tinker
>>> $pwd = \App\Models\Setting::get('settlement_password');
>>> echo $pwd;  // 查看当前哈希值
>>> password_verify('123456', $pwd);  // 测试默认密码
>>> exit
```

### 问题4: API返回 404

**原因**：路由缓存问题

**解决**：
```bash
php artisan route:clear
php artisan route:cache
php artisan route:list | grep settlement
```

### 问题5: 前端页面空白

**原因**：路由未正确配置或组件导入失败

**解决**：
1. 检查浏览器控制台错误
2. 验证路由配置
3. 确认组件文件存在

---

## 📊 数据验证SQL

```sql
-- 1. 检查表结构
DESC settlements;

-- 2. 查看所有结余记录
SELECT 
    id,
    settlement_date,
    previous_capital,
    outgoing_profit,
    instant_profit,
    profit,
    other_expenses_total,
    new_capital,
    created_at
FROM settlements
ORDER BY settlement_date DESC
LIMIT 10;

-- 3. 检查唯一索引
SELECT 
    COUNT(*) as count,
    settlement_date 
FROM settlements 
GROUP BY settlement_date 
HAVING count > 1;
-- 应该返回0条记录

-- 4. 查看密码配置
SELECT * FROM settings WHERE key_name = 'settlement_password';
```

---

## 🔐 安全建议

1. ⚠️ **立即修改默认密码** `123456`
2. ⚠️ **使用HTTPS** 传输敏感数据
3. ⚠️ **备份数据库** 执行迁移前务必备份
4. ⚠️ **测试环境** 先在测试环境验证
5. ⚠️ **权限控制** 配置适当的API权限

---

## 📞 支持信息

### 相关文档

- `系统需求整理.md` - 完整需求文档
- `backend/MIGRATION_GUIDE.md` - 迁移指南

### 测试数据

**默认密码**：`123456`

**测试用户**：根据您的系统配置

**测试场景**：
1. 无交易的结余（应提示错误）
2. 只有入账和出账的结余
3. 包含即时买断的结余
4. 重复结余（应被阻止）

---

## ✅ 部署检查清单

部署前：
- [ ] 已备份数据库
- [ ] 已备份代码
- [ ] 已在测试环境验证

数据库：
- [ ] 执行了3个迁移文件
- [ ] settlements表有新字段
- [ ] 有唯一索引 unique_settlement_date
- [ ] settings表有密码配置

后端：
- [ ] 清除了缓存
- [ ] API端点可以访问
- [ ] 密码验证正常

前端：
- [ ] 3个新页面可以访问
- [ ] 路由配置正确
- [ ] API调用正常

安全：
- [ ] 已修改默认密码
- [ ] 生产环境使用HTTPS

---

**部署日期**: _____________  
**部署人员**: _____________  
**版本**: v1.0  
**状态**: ✅ 开发完成，待部署

