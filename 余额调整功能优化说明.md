# 余额调整功能优化说明

## 更新日期
2025-10-24

## 优化内容

### 1. 余额调整列表页面优化（主从结构）

**原有功能：**
- 直接显示所有调整记录列表

**优化后：**
- 采用**主从页面结构**：
  - **主页面**：渠道余额总览（默认页面）
  - **详情页面**：点击渠道后查看该渠道的详细信息和调整记录

#### 主页面 - 渠道余额总览

访问 `/admin/balance-adjustments` 后直接显示所有渠道的余额列表。

显示内容包括：

| 列名 | 说明 |
|------|------|
| 渠道名称 | 支付渠道名称（可搜索、排序） |
| 渠道编码 | 渠道唯一标识码 |
| 渠道类别 | 渠道分类（徽章显示） |
| 人民币余额 | 当前RMB余额（负数红色，正数绿色） |
| 港币余额 | 当前HKD余额（负数红色，正数绿色） |
| 最后调整时间 | 最近一次调整的时间 |
| 调整次数 | 该渠道的调整记录总数 |

**操作按钮：**
- 每行有"查看详情"按钮，点击后进入该渠道的详情页面

#### 详情页面 - 渠道余额详情

点击某个渠道的"查看详情"后，显示该渠道的完整信息：

**1. 渠道信息卡片**
- 渠道名称、编码、类别

**2. 当前余额卡片**（大字号、醒目显示）
- 人民币余额（¥ xx,xxx.xx）
- 港币余额（HK$ xx,xxx.xx）

**3. 统计信息卡片**
- 总调整次数
- 手动调整次数
- 系统调整次数
- 最后调整时间

**4. 调整记录表格**
显示该渠道的所有历史调整记录，包括：
- ID、货币、调整前金额、调整金额、调整后金额
- 类型（手动/系统）
- 操作人员
- 调整原因
- 调整时间

**操作按钮：**
- 返回列表：返回主页面
- 创建调整：为该渠道创建新的调整（自动预选渠道）

### 2. 创建余额调整表单优化

**原有逻辑：**
- 需要输入"调整金额"（正数为增加，负数为减少）
- 系统自动计算"调整后金额"

**优化后：**
- 直接输入"调整后金额"（目标金额）
- 系统自动计算并显示"调整金额"（差额）

#### 表单字段说明

**调整信息部分：**

| 字段 | 类型 | 说明 |
|------|------|------|
| 支付渠道 | 下拉选择 | 选择要调整的渠道，自动加载当前余额 |
| 货币类型 | 下拉选择 | 选择RMB或HKD |
| 当前人民币余额 | 只读 | 选择RMB时显示 |
| 当前港币余额 | 只读 | 选择HKD时显示 |

**调整详情部分：**

| 字段 | 类型 | 说明 |
|------|------|------|
| 调整前金额 | 只读 | 自动填充当前余额 |
| **调整后金额** | **输入** | **直接输入调整后的目标金额**（重点优化） |
| 调整金额 | 只读 | 自动计算：调整后金额 - 调整前金额 |
| 调整原因 | 文本域 | 必填，说明调整原因 |

### 3. 交互流程

1. 选择支付渠道 → 自动加载该渠道的RMB和HKD余额
2. 选择货币类型 → 自动填充"调整前金额"
3. **输入"调整后金额"** → 系统自动计算"调整金额"并显示
4. 填写调整原因
5. 提交表单

**示例：**
```
当前RMB余额：10,000.00 元
调整后金额：12,500.00 元（手动输入）
自动计算调整金额：+2,500.00 元（系统自动显示）
```

## 技术实现

### 修改的文件

1. **ListBalanceAdjustments.php**
   - 路径：`backend/app/Filament/Resources/BalanceAdjustmentResource/Pages/ListBalanceAdjustments.php`
   - 修改：主页面显示渠道列表而非调整记录
   - 新增：调整次数统计列
   - 新增："查看详情"按钮，跳转到渠道详情页

2. **ViewChannelBalance.php**（新增文件）
   - 路径：`backend/app/Filament/Resources/BalanceAdjustmentResource/Pages/ViewChannelBalance.php`
   - 新增：渠道详情页面
   - 新增：渠道信息、余额、统计信息的Infolist展示
   - 新增：该渠道的调整记录表格
   - 新增：返回列表、创建调整按钮

3. **view-channel-balance.blade.php**（新增文件）
   - 路径：`backend/resources/views/filament/resources/balance-adjustment-resource/pages/view-channel-balance.blade.php`
   - 新增：渠道详情页面的视图模板

4. **BalanceAdjustmentResource.php**
   - 路径：`backend/app/Filament/Resources/BalanceAdjustmentResource.php`
   - 调整表单字段顺序
   - 修改"调整后金额"为可输入字段
   - 修改"调整金额"为自动计算字段
   - 添加响应式逻辑，实现自动计算
   - 新增：'channel' 路由，指向渠道详情页

5. **CreateBalanceAdjustment.php**
   - 路径：`backend/app/Filament/Resources/BalanceAdjustmentResource/Pages/CreateBalanceAdjustment.php`
   - 新增：从URL参数预选渠道功能
   - 修改：创建后跳转逻辑（如果从详情页创建，返回详情页）
   - 添加后端验证，确保adjustment_amount正确计算

### 核心逻辑

**表单响应式计算：**
```php
// 当"调整后金额"改变时，自动计算"调整金额"
->afterStateUpdated(function (callable $set, $state, Forms\Get $get) {
    $beforeAmount = $get('before_amount');
    if ($beforeAmount !== null && $state !== null) {
        $adjustmentAmount = $state - $beforeAmount;
        $set('adjustment_amount', $adjustmentAmount);
    }
})
```

**余额获取逻辑：**
```php
// 从Channel模型获取实时余额
$channel->getRmbBalance();  // 获取RMB余额
$channel->getHkdBalance();  // 获取HKD余额
```

## 用户体验改进

### 改进前：
1. 进入页面看到的是调整记录列表，无法快速了解各渠道当前余额
2. 需要到其他页面查看渠道余额
3. 创建调整时需要心算：想调整到12000，当前10000，需要输入+2000

### 改进后：
1. ✅ 进入页面首先看到所有渠道余额总览，一目了然
2. ✅ 点击"查看详情"进入渠道专属页面，查看完整信息和调整历史
3. ✅ 详情页大字号显示当前余额，醒目直观
4. ✅ 详情页显示统计信息（调整次数、最后调整时间等）
5. ✅ 可以直接在详情页创建调整，自动预选当前渠道
6. ✅ 创建调整时直接输入目标金额（12000），系统自动计算差额（+2000）
7. ✅ 更符合财务人员的操作习惯

### 页面流程
```
主页面（渠道列表）
    ↓ 点击"查看详情"
详情页（渠道信息 + 余额 + 调整记录）
    ↓ 点击"创建调整"
创建页面（预选当前渠道）
    ↓ 提交
返回详情页（查看新增记录）
```

## 测试建议

1. **主页面测试：**
   - 访问 `/admin/balance-adjustments`
   - 验证显示所有渠道列表
   - 验证各渠道余额计算正确
   - 验证调整次数统计正确
   - 验证搜索和排序功能

2. **详情页面测试：**
   - 点击任意渠道的"查看详情"按钮
   - 验证页面标题显示正确（渠道名 - 余额详情）
   - 验证渠道信息卡片显示正确
   - 验证当前余额卡片显示正确（大字号、颜色）
   - 验证统计信息准确
   - 验证调整记录表格显示该渠道的所有记录
   - 验证筛选器（货币、类型）工作正常

3. **创建调整测试：**
   - 从主页面点击"创建"按钮
     - 验证可以手动选择渠道
   - 从详情页点击"创建调整"按钮
     - 验证自动预选当前渠道
   - 选择货币类型
   - 输入调整后金额
   - 验证调整金额自动计算正确
   - 提交表单，验证保存成功
   - 从详情页创建的，应返回详情页
   - 从主页面创建的，应返回主页面
   - 验证余额更新正确

4. **边界测试：**
   - 输入负数的调整后金额（余额减少）
   - 输入小数（2位小数）
   - 快速切换渠道和货币
   - 验证所有计算都准确无误
   - 测试没有调整记录的渠道
   - 测试余额为负数的渠道（红色显示）

## 注意事项

1. 系统会自动保存 `adjustment_amount`（调整金额），这个值用于：
   - 历史记录显示
   - 余额计算
   - 财务报表

2. 调整后金额可以小于调整前金额（余额减少的场景）

3. 所有金额保留2位小数

4. 必须填写调整原因，用于审计追踪

## 权限要求

- 查看权限：所有用户可见
- 创建权限：仅管理员和财务人员
- 导出权限：仅管理员和财务人员

