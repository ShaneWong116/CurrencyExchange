
# 需求文档(后台)
（管理端）

## 1. 项目概述
后台系统为 **财务人员** 和 **管理员** 提供统一的管理入口，主要包括 **仪表盘、交易记录、支付渠道、账户管理、系统设置** 模块。  
支持角色与权限控制，保障数据安全与分级使用。

## 2. 用户与权限
- **管理员**
  - 管理系统配置、支付渠道、账户
  - 可查看、编辑所有交易数据
- **财务人员**
  - 主要负责交易数据审核、导出、查询
  - 无法修改系统参数和用户

## 3. 功能需求

### 3.1 登录与安全
- 独立后台登录页，账号 + 密码方式
- 支持多角色鉴权（财务、管理员）
- 登录后获取 Access Token + Refresh Token
- 支持后台强制登出与安全日志

### 3.2 仪表盘
- **今日支付渠道汇总卡片**（表格形式）：
  - 支付渠道
  - 交易笔数
  - 总入账金额
  - 总出账金额
  - 渠道余额

- **财务类仪表盘补充**
  - 今日/本月收入趋势图
  - 今日/本月支出趋势图
  - 人民币与港币资金分布（饼图）
  - 各支付渠道交易量对比（柱状图）
  - 账户余额变化趋势

### 3.3 交易记录
- **交易列表**：
  - 列：交易号、人员、地点、交易类型（入/出）、货币类型、金额、支付渠道、状态、备注、创建时间
  - 支持列拖动排序、隐藏显示

- **筛选功能**
  - 按时间范围（今日、本周、本月、自定义）
  - 入账/出账
  - 人民币/港币

- **操作**
  - 查看交易详情
  - 编辑交易记录（仅管理员可修改）
  - 导出：月结、年结报表（Excel / PDF）

### 3.4 支付渠道管理
- **字段**
  - 渠道名称
  - 标签（如：线上、线下、第三方）
  - 分类（银行、电子钱包、现金等）
  - 启用状态（启用/停用）
  - 交易计数（累计交易次数）

- **功能**
  - 管理员可新增、修改、停用渠道
  - 财务人员可查看渠道信息
  - 系统自动统计渠道交易笔数和余额

### 3.5 账户管理
- 用于管理员创建和管理后台账户
- **字段**：账号、角色、状态、最后登录时间
- 功能：
  - 新增账号（分配角色）
  - 编辑账号（修改密码、角色、状态）
  - 禁用/启用账号

### 3.6 系统设置
- 由管理员维护，涉及系统全局参数：
  - Token 过期时间（Access/Refresh）
  - 自动登出时间
  - 图片处理参数（最大文件大小、压缩质量、允许格式）
  - 汇率精度（小数位数）
  - 日志保存周期
- 修改系统参数需要管理员权限

### 3.7 余额管理与计算
- **初始金额配置**
  - 管理员可设置每个支付渠道的初始金额（分人民币和港币）
  - 支持手动调整初始余额
  - 记录余额调整历史和原因

- **自动余额计算**
  - 系统每天0点自动计算新一天的初始金额
  - 计算公式：新初始金额 = 前一天初始金额 + 当日入账 - 当日出账
  - 按货币类型（人民币/港币）分别计算
  - 按支付渠道分别维护余额

- **实时余额显示**
  - 仪表盘实时显示各渠道当前余额
  - 余额变化趋势图表
  - 支持查看历史余额记录

### 3.8 草稿功能
- **草稿交易记录**
  - 用户可将未完成的交易记录保存为草稿
  - 草稿不影响正式交易数据和余额计算
  - 支持草稿的增删改查操作

- **草稿管理**
  - 草稿列表显示：交易信息、创建人、创建时间、最后修改时间
  - 草稿可编辑所有字段
  - 草稿可提交转为正式交易记录
  - 草稿可删除或设置自动清理规则
  - 系统每天0点自动清理所有草稿记录

- **草稿状态跟踪**
  - 显示草稿创建和修改历史
  - 支持草稿备注和状态标记

## 4. 数据存储与接口设计

### 4.1 数据表建议
- `transactions`：交易记录表
- `transaction_drafts`：交易草稿表
- `channels`：支付渠道表
- `channel_balances`：渠道余额表（记录每日初始金额和余额变化）
- `balance_adjustments`：余额调整记录表
- `images`：图片存储表（存储图片元数据和文件内容）
- `users`：后台用户表
- `roles`：角色与权限表
- `settings`：系统参数配置
- `audit_logs`：操作日志表

### 4.2 接口需求
- 登录鉴权接口
- 交易数据查询/导出接口
- 交易草稿 CRUD 接口
- 支付渠道 CRUD 接口
- 余额管理接口（查询、调整、历史记录）
- 余额计算接口（手动触发计算）
- 图片管理接口（上传、下载、删除、查看）
- 账户管理接口
- 系统参数接口

## 5. 非功能需求
- **安全性**
  - RBAC 权限模型
  - 全站 HTTPS
  - 日志审计（所有操作需记录）

- **性能**
  - 交易数据分页加载
  - 报表导出支持大数据量（异步导出+通知）

- **可用性**
  - 列自定义显示/隐藏保存到用户配置
  - 多维度图表帮助财务快速分析

## 6. 用户流程图（后台）
```
登录 → 仪表盘（今日汇总）
        ├─ 交易记录（查询、筛选、导出）
        ├─ 支付渠道（配置、统计）
        ├─ 账户管理（创建、修改、禁用）
        └─ 系统设置（参数配置）
```

## 7. 技术栈选型

### 7.1 后端技术栈
- **核心框架**：Laravel 10 + PHP 8.2
  - Laravel：PHP 最优秀的全栈框架
  - 内置认证、权限、队列、缓存系统
  - 强大的 ORM（Eloquent）和数据库迁移
  - 丰富的生态系统和第三方包

- **管理后台**：Laravel Filament 3
  - 现代化管理界面，基于 Livewire + Alpine.js
  - 零代码生成 CRUD 界面
  - 内置权限管理、数据筛选、导出功能
  - 支持自定义仪表盘和图表组件

- **API 开发**：Laravel Sanctum + API Resources
  - Sanctum：轻量级 API 认证系统
  - API Resources：标准化 API 响应格式
  - 支持 Access Token + Refresh Token 机制

### 7.2 数据存储
- **主数据库**：MySQL 8.0
  - 支持事务处理，保证数据一致性
  - 优秀的性能和可扩展性
  - 完善的备份和恢复机制

- **缓存系统**：Redis 7.0
  - 会话存储和 Token 管理
  - 数据缓存，提升查询性能
  - 队列处理（异步任务）

- **图片存储**：数据库存储
  - 图片元数据（文件名、大小、类型等）存储在数据库
  - 图片文件以 Base64 或二进制格式直接存储在数据库
  - 支持图片压缩和尺寸优化
  - 简化存储架构，无需外部依赖
  - 适合小到中等规模的图片存储需求

### 7.3 核心扩展包
- **权限管理**：spatie/laravel-permission
- **Excel 导出**：maatwebsite/excel
- **图片处理**：intervention/image
- **队列监控**：laravel/horizon
- **API 文档**：knuckleswtf/scribe
- **数据填充**：fakerphp/faker

### 7.4 开发环境
- **本地环境**：Laravel Sail（Docker）或 Laragon
- **包管理**：Composer + NPM
- **代码规范**：Laravel Pint + PHPStan
- **测试框架**：PHPUnit + Laravel Dusk
- **版本控制**：Git + GitFlow

### 7.5 生产环境部署
- **Web 服务器**：Nginx + PHP-FPM
- **进程管理**：Supervisor（队列任务）
- **监控工具**：Laravel Telescope + Laravel Pulse
- **日志管理**：Laravel Log + 云日志服务
- **备份策略**：数据库定时备份 + 文件同步备份

### 7.6 安全加固
- **HTTPS**：SSL 证书 + HSTS
- **防火墙**：云安全组 + Web 应用防火墙
- **数据加密**：Laravel 内置加密 + 数据库加密
- **访问控制**：IP 白名单 + 频率限制
- **安全审计**：操作日志 + 异常监控
