# 结余功能使用指南

## 🚀 快速开始

### 后台管理员使用（推荐）

#### 步骤 1: 登录后台
访问: `http://your-domain/admin`

#### 步骤 2: 查看 Dashboard
登录后可以在首页看到**结余统计Widget**，包含：
- 当前结余汇率
- 预计利润
- 未结余交易数
- 上次结余时间

#### 步骤 3: 进入结余管理
点击侧边栏 **"结余管理"** 菜单

#### 步骤 4: 执行结余
1. 点击右上角 **"🧮 执行结余"** 按钮
2. 查看弹窗中的预览数据：
   - ✅ 当前本金、港币结余、人民币余额
   - ✅ 结余汇率、利润
   - ✅ 未结余交易统计
   - ✅ 预期结余后状态

3. 添加其他支出（可选）：
   - 点击 **"+ 添加支出项目"**
   - 填写支出项目名称（如：薪金、金流费用等）
   - 填写金额
   - 可添加多项支出

4. 填写备注（可选）

5. 点击 **"确认执行结余"**

#### 步骤 5: 查看结果
- 执行成功后自动跳转到详情页
- 可以看到完整的结余信息，包括：
  - 结余前后本金对比
  - 利润明细
  - 其他支出明细
  - 关联的交易统计

---

### API 调用（前端开发）

#### 1. 获取结余预览
```http
GET /api/settlements/preview
Authorization: Bearer {token}
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "current_capital": 1000000,
    "current_hkd_balance": 526315,
    "rmb_balance_total": 500000,
    "settlement_rate": 0.976,
    "profit": 400,
    "expected_new_capital": 1000400,
    "expected_new_hkd_balance": 526715,
    "can_settle": true,
    "unsettled_income_count": 2,
    "unsettled_outcome_count": 1
  }
}
```

#### 2. 执行结余
```http
POST /api/settlements
Authorization: Bearer {token}
Content-Type: application/json

{
  "expenses": [
    {
      "item_name": "薪金",
      "amount": 100
    },
    {
      "item_name": "金流费用",
      "amount": 200
    }
  ],
  "notes": "10月份结余"
}
```

**响应示例**：
```json
{
  "success": true,
  "message": "结余操作成功",
  "data": {
    "settlement": {
      "id": 1,
      "sequence_number": 1,
      "previous_capital": 1000000,
      "profit": 400,
      "other_expenses_total": 300,
      "new_capital": 1000100,
      "settlement_rate": 0.976,
      "created_at": "2025-10-23 18:00:00"
    },
    "expenses": [...],
    "transactions_count": 3
  }
}
```

#### 3. 查看结余详情
```http
GET /api/settlements/{id}
Authorization: Bearer {token}
```

#### 4. 获取结余历史
```http
GET /api/settlements?page=1&per_page=20
Authorization: Bearer {token}
```

---

## 📋 功能说明

### 什么是结余？
结余是系统定期进行的利润结算操作，主要功能：
1. 计算当前结余汇率
2. 计算利润（出账收益 - 成本）
3. 更新本金和港币结余
4. 将未结余交易标记为已结余

### 结余汇率如何计算？
```
人民币总量 = 各渠道人民币余额 + 未结余入账人民币
港币总量 = 当前港币结余 + 未结余入账港币
结余汇率 = 人民币总量 ÷ 港币总量
```

### 利润如何计算？
```
出账港币总额 = 所有未结余出账交易的港币金额之和
出账港币成本 = 所有未结余出账交易的人民币金额之和 ÷ 结余汇率
利润 = 出账港币总额 - 出账港币成本
```

### 结余后数据如何更新？
```
新本金 = 当前本金 + 利润 - 其他支出
新港币结余 = 当前港币结余 + 利润
```

---

## ⚠️ 重要提示

### 执行结余前的检查
1. ✅ 确认有未结余的交易
2. ✅ 检查人民币余额是否正确
3. ✅ 检查港币结余是否正确
4. ✅ 核对结余汇率是否合理
5. ✅ 核对利润计算是否正确

### 注意事项
1. **不可逆操作**
   - 结余记录一旦创建，不可修改和删除
   - 执行前请仔细核对所有数据

2. **其他支出**
   - 可以不填写其他支出（默认为0）
   - 支出金额不能为负数
   - 支出会从本金中扣除，但不影响港币结余

3. **交易状态**
   - 结余后，所有未结余交易自动变为"已结余"
   - 已结余交易不再参与下次结余计算

4. **并发问题**
   - 同一时间建议只有一个人执行结余
   - 系统使用数据库事务保证数据一致性

---

## 🎯 典型使用场景

### 场景1：每日结余
**时间**: 每天营业结束后

**步骤**:
1. 检查当天的入账和出账交易是否都已提交
2. 登录后台查看结余预览
3. 执行结余（一般不需要填写其他支出）
4. 查看详情确认结余成功

---

### 场景2：月度结余（含其他支出）
**时间**: 每月最后一天

**步骤**:
1. 检查本月所有交易是否已提交
2. 准备其他支出清单（薪资、租金、水电等）
3. 登录后台执行结余
4. 添加所有其他支出项目
5. 填写备注（如：10月份结余）
6. 执行结余
7. 导出结余报表（可选）

---

### 场景3：查看历史结余
**目的**: 查看过往结余记录

**步骤**:
1. 进入"结余管理"页面
2. 查看结余列表（按序号降序）
3. 点击任意记录查看详情
4. 查看本金变化、利润、支出明细等

---

## 📊 数据解读

### Dashboard Widget 解读

#### 当前结余汇率: 0.976
**含义**: 当前1港币可以兑换0.976人民币  
**用途**: 衡量当前人民币库存的价值

#### 预计利润: +400.00 HKD
**含义**: 如果现在结余，预计可获利400港币  
**说明**: 
- 绿色 ➜ 盈利
- 红色 ➜ 亏损

#### 未结余交易: 3 笔
**含义**: 还有3笔交易未结余  
**说明**: 入账2笔，出账1笔

#### 上次结余时间: 10-23 18:00
**含义**: 最近一次结余的时间  
**说明**: 序号 #3

---

### 结余详情页解读

#### 结余概览
- **序号**: 第几次结余（连续递增）
- **时间**: 结余执行时间
- **汇率**: 本次结余使用的汇率

#### 本金变化
```
结余前本金: 1,000,000 HKD
+ 利润:        +400 HKD
- 其他支出:     -300 HKD
= 结余后本金: 1,000,100 HKD
```

#### 港币结余变化
```
结余前港币结余: 526,315 HKD
+ 利润:           +400 HKD
= 结余后港币结余: 526,715 HKD
```

---

## 🔍 常见问题

### Q1: 为什么不能执行结余？
**A**: 可能的原因：
1. 没有未结余的交易
2. 港币结余为0或异常
3. 网络连接问题

**解决方法**：
- 检查是否有未提交的草稿
- 检查系统设置中的港币结余
- 刷新页面重试

---

### Q2: 利润为负数是正常的吗？
**A**: 可能正常，也可能异常

**正常情况**：
- 出账时使用的汇率低于当前结余汇率
- 市场汇率波动导致成本增加

**异常情况**：
- 交易汇率录入错误
- 渠道余额数据错误

**建议**：利润异常时暂停结余，先核查交易数据

---

### Q3: 其他支出会影响港币结余吗？
**A**: 不会

- 其他支出只从**本金**中扣除
- **港币结余**只受利润影响
- 这符合业务逻辑：其他支出是额外开支，不是交易成本

---

### Q4: 结余后还能修改交易吗？
**A**: 不建议

- 已结余的交易理论上不应修改
- 修改会导致历史数据不一致
- 如确需修改，建议：
  1. 联系管理员
  2. 记录修改原因
  3. 必要时重新结余

---

### Q5: 如何导出结余报表？
**A**: 方式1：使用浏览器打印功能
1. 打开结余详情页
2. Ctrl+P 打印
3. 选择"另存为PDF"

**方式2**：后续可开发Excel导出功能

---

## 📞 技术支持

如遇到问题，请联系：
- 技术支持邮箱: support@example.com
- 系统管理员: admin@example.com

---

**文档版本**: v1.0  
**最后更新**: 2025-10-23

