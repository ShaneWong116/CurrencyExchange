# 数据恢复指南

## 从旧的SQLite备份文件恢复数据

### 适用场景
- 有旧版本的 `database.sqlite` 备份文件
- 数据库结构已更新,但想保留旧数据
- 从测试环境迁移到生产环境

### 使用步骤

#### 1. 准备备份文件
将您的备份文件(如 `database_backup.sqlite`)放在方便访问的位置。

#### 2. 运行恢复脚本
```bash
cd backend
php restore_from_backup.php <备份文件路径>
```

例如:
```bash
# 如果备份文件在backend目录的上一级
php restore_from_backup.php ../database_backup.sqlite

# 如果备份文件在database目录
php restore_from_backup.php database/database_backup.sqlite

# 如果是绝对路径
php restore_from_backup.php E:\backup\database.sqlite
```

#### 3. 查看分析结果
脚本会自动分析:
- ✅ 备份数据库的表结构
- ✅ 当前数据库的表结构
- ✅ 字段差异和映射关系
- ✅ 各表的数据量

输出示例:
```
1. 分析备份数据库结构...
   - id (INTEGER)
   - uuid (varchar)
   - type (varchar)
   ...

2. 分析当前数据库结构...
   - id (INTEGER)
   - uuid (varchar)
   - type (varchar)
   - settlement_status (varchar)  <- 新增字段
   ...

3. 字段映射分析...
   共同字段: id, uuid, user_id, type, rmb_amount, ...
   ℹ️  当前数据库新增字段(将使用默认值): settlement_status, settlement_id

4. 统计备份数据...
   - transactions: 156 条记录
   - channels: 8 条记录
   - field_users: 3 条记录
```

#### 4. 确认恢复
脚本会要求确认:
```
5. 确认恢复操作
   ⚠️  警告: 此操作将清空当前数据库的以下表并恢复备份数据:
      - transactions (156 条记录)
      - channels (8 条记录)
      - field_users (3 条记录)

   是否继续? (yes/no):
```

输入 `yes` 继续,或 `no` 取消。

#### 5. 等待恢复完成
```
6. 开始恢复数据...
   恢复 field_users...
      ✅ 完成: 导入 3 条, 跳过 0 条
   恢复 channels...
      ✅ 完成: 导入 8 条, 跳过 0 条
   恢复 transactions...
      ✅ 完成: 导入 156 条, 跳过 0 条

✅ 数据恢复完成!
```

### 重要说明

#### 智能字段映射
脚本会自动处理:
- ✅ **共同字段**: 直接复制数据
- ✅ **新增字段**: 使用默认值
  - `settlement_status` → `'unsettled'`
  - `status` → `'success'`
  - `settlement_id` → `NULL`
  - `settlement_date` → `NULL`
  - `transaction_label` → `NULL`
  - `instant_profit` → `NULL`（即时买断利润，旧数据为空，可在录入新交易时自动计算）
- ⚠️ **已删除字段**: 自动忽略

#### 数据完整性
- ✅ 自动处理外键约束
- ✅ 保持数据关联关系
- ✅ 按正确顺序恢复(基础表 → 关联表)

#### 安全保障
- ✅ 使用事务,出错自动回滚
- ✅ 恢复前要求确认
- ✅ 详细的错误提示

### 恢复后检查

1. **检查交易记录**
   - 访问前端记录页面
   - 确认交易数量和内容正确
   - 检查各类型交易(入账/出账/即时买断/兑换)
   - ⚠️ **即时买断交易说明**：从旧备份恢复的即时买断交易 `instant_profit` 字段为空，这是正常的。新录入的即时买断交易会在录入时自动计算利润并保存。

2. **检查渠道余额**
   - 查看各渠道的人民币和港币余额
   - 确认余额计算正确

3. **检查外勤人员**
   - 确认所有外勤人员信息完整
   - 检查用户权限

4. **检查地点信息**
   - 确认交易地点数据正确

### 常见问题

#### Q: 备份数据库缺少某些表怎么办?
A: 脚本会自动跳过不存在的表,只恢复存在的表。

#### Q: 字段类型不匹配怎么办?
A: 脚本会尝试自动转换,如果失败会跳过该记录并显示错误信息。

#### Q: 恢复失败如何回滚?
A: 脚本使用事务,失败会自动回滚,不会破坏当前数据。

#### Q: 可以部分恢复吗?
A: 目前脚本恢复所有表。如需部分恢复,可以修改脚本中的 `$restoreOrder` 数组。

#### Q: 旧备份中的即时买断交易利润为空怎么办?
A: 这是正常的。旧版本系统没有在录入时保存即时买断利润。从 v4.0 版本开始，新录入的即时买断交易会自动计算并保存利润。旧数据的即时买断利润会在结余时重新计算，不影响使用。

### 手动恢复(备选方案)

如果自动恢复脚本不适用,可以手动恢复:

#### 方案1: 使用SQLite工具
```bash
# 1. 附加备份数据库
sqlite3 database/database.sqlite

# 2. 在SQLite中执行
ATTACH DATABASE 'path/to/backup.sqlite' AS backup;

# 3. 复制数据
INSERT INTO transactions 
  (id, uuid, user_id, type, rmb_amount, hkd_amount, ...)
SELECT 
  id, uuid, user_id, type, rmb_amount, hkd_amount, ...
FROM backup.transactions;

# 4. 分离数据库
DETACH DATABASE backup;
```

#### 方案2: 导出/导入CSV
```bash
# 1. 从备份数据库导出CSV
sqlite3 backup.sqlite ".mode csv" ".output transactions.csv" "SELECT * FROM transactions;"

# 2. 手动调整CSV文件以匹配新结构

# 3. 导入到当前数据库
sqlite3 database.sqlite ".mode csv" ".import transactions.csv transactions"
```

### 技术细节

脚本处理的表(按顺序):
1. `field_users` - 外勤人员
2. `channels` - 渠道
3. `locations` - 地点
4. `transactions` - 交易记录

跳过的表(由系统管理):
- `migrations` - 迁移记录
- `users` - 管理员用户
- `roles` - 角色权限
- `settings` - 系统设置
- `settlements` - 结余记录

### 获取帮助

如果遇到问题:
1. 查看脚本输出的详细错误信息
2. 检查备份文件是否完整
3. 确认当前数据库结构是否最新(运行 `php artisan migrate`)
4. 联系技术支持

