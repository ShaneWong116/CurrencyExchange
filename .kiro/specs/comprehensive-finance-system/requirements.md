# 需求文档

## 介绍

本文档概述了综合财务系统的需求，该系统包括面向外勤人员的移动端前台应用和面向财务人员及管理员的后台管理系统。系统支持交易录入、兑换记录、草稿管理、离线功能以及基于角色的综合财务管理。

## 需求

### 需求 1

**用户故事：** 作为外勤人员，我希望能够使用凭据安全登录移动应用，以便我可以访问交易录入和草稿管理功能。

#### 验收标准

1. 当外勤人员访问登录页面时，系统应当显示针对移动端优化的登录表单，包含用户名和密码字段
2. 当用户提交有效凭据时，系统应当验证用户身份并返回访问令牌（30分钟有效期）和刷新令牌（7天有效期）
3. 当登录失败时，系统应当显示相应的错误信息
4. 当用户无操作超过15分钟时，系统应当自动登出用户
5. 当即将自动登出时，系统应当显示1分钟警告并提供"保持登录"选项
6. 当用户登出时，系统应当清除本地令牌，同时保留草稿和提交队列数据
7. 当管理账户时，系统应当仅允许后台创建账户（前台不支持注册或密码找回）

### 需求 2

**用户故事：** 作为外勤人员，我希望能够访问简洁的首页并有清晰的导航选项，以便我可以快速选择交易录入或草稿编辑。

#### 验收标准

1. 当用户成功登录时，系统应当显示包含两个主要入口的首页
2. 当查看首页时，系统应当清晰显示"交易录入"和"编辑草稿"选项
3. 当界面加载时，系统应当优先采用移动端设计以获得最佳移动体验

### 需求 3

**用户故事：** 作为外勤人员，我希望能够记录收入和支出交易及相关详情，以便我可以在现场捕获所有必要的财务数据。

#### 验收标准

1. 当访问交易录入时，系统应当提供带有底部导航的"录入"页面
2. 当输入交易数据时，系统应当要求选择交易类型（入账/出账）
3. 当输入金额时，系统应当要求至少填写一种货币（人民币或港币），可选择同时填写两种
4. 当选择渠道时，系统应当提供由后台维护的下拉列表
5. 当上传图片时，系统应当支持从相机或相册选择多张图片（可选）
6. 当完成录入时，系统应当提供"提交"和"存为草稿"按钮
7. 当在线提交时，系统应当直接提交到后台
8. 当离线时，系统应当保存到本地提交队列并标记为待处理状态

### 需求 4

**用户故事：** 作为外勤人员，我希望能够记录货币兑换交易并自动计算汇率，以便我可以准确捕获兑换操作。

#### 验收标准

1. 当访问兑换录入时，系统应当提供可通过底部导航访问的"兑换"页面
2. 当输入兑换数据时，系统应当要求同时填写人民币和港币金额
3. 当输入金额时，系统应当自动计算即时汇率（港币/人民币，保留5位小数，四舍五入）
4. 当输入交易汇率时，系统应当允许手动输入，保留5位小数并四舍五入
5. 当完成兑换录入时，系统应当提供"提交"和"存为草稿"按钮
6. 当提交时，系统应当遵循与常规交易相同的在线/离线逻辑

### 需求 5

**用户故事：** 作为外勤人员，我希望能够管理我的草稿交易，以便我可以在方便时完成并提交未完成的条目。

#### 验收标准

1. 当访问草稿管理时，系统应当显示所有未提交草稿的列表
2. 当查看草稿列表时，系统应当显示草稿类型、金额、渠道和最后修改时间
3. 当选择草稿时，系统应当加载草稿数据进行编辑
4. 当编辑草稿时，系统应当允许修改并提供提交或保存选项
5. 当成功提交草稿时，系统应当更新草稿状态并同步到后台
6. 当存储草稿时，系统应当使用本地数据库（SQLite/IndexedDB）加云端存储

### 需求 6

**用户故事：** 作为外勤人员，我希望系统能够优雅地处理离线场景，以便我可以在没有网络连接的情况下继续工作。

#### 验收标准

1. 当有网络连接时提交，系统应当直接提交到后台
2. 当无网络连接时提交，系统应当保存到本地提交队列并标记为待处理状态
3. 当网络恢复时，系统应当自动检测并批量上传队列中的项目
4. 当上传成功时，系统应当将状态更新为成功
5. 当上传失败时，系统应当将状态更新为失败并允许手动重试
6. 当离线处理图片时，系统应当存储本地路径并在文本数据提交后上传
7. 当防止冲突时，系统应当使用UUID确保幂等性，使用lastModified时间戳进行版本控制

### 需求 7

**用户故事：** 作为财务人员或管理员，我希望能够安全访问后台管理系统，以便我可以根据角色权限管理财务数据。

#### 验收标准

1. 当访问后台登录时，系统应当显示独立的管理员登录页面，包含用户名和密码
2. 当认证成功时，系统应当返回访问令牌和刷新令牌，并具有基于角色的权限
3. 当管理员登录时，系统应当授予所有系统配置、支付渠道和账户管理的访问权限
4. 当财务人员登录时，系统应当授予交易审核、导出和查询的访问权限，但限制系统修改
5. 当实施安全措施时，系统应当支持强制登出并维护安全审计日志

### 需求 8

**用户故事：** 作为财务人员或管理员，我希望能够查看综合仪表盘分析，以便我可以快速了解当前财务状况和趋势。

#### 验收标准

1. 当查看仪表盘时，系统应当显示今日支付渠道汇总表，包含渠道名称、交易笔数、总入账/出账金额和渠道余额
2. 当分析趋势时，系统应当显示今日和本月收入/支出趋势图表
3. 当查看资金分布时，系统应当以饼图格式显示人民币和港币分布
4. 当比较渠道时，系统应当以柱状图格式显示交易量比较
5. 当跟踪余额时，系统应当显示账户余额随时间的变化趋势
6. 当数据更新时，系统应当实时或近实时刷新仪表盘

### 需求 9

**用户故事：** 作为财务人员或管理员，我希望能够全面管理交易记录，以便我可以有效地跟踪、筛选和导出财务数据。

#### 验收标准

1. 当查看交易时，系统应当显示包含交易ID、人员、地点、类型、货币、金额、渠道、状态、备注和创建时间的列表
2. 当自定义视图时，系统应当支持列的拖拽排序和显示/隐藏功能
3. 当筛选数据时，系统应当支持按时间范围（今日、本周、本月、自定义）、交易类型和货币筛选
4. 当查看详情时，系统应当在点击时显示完整的交易信息
5. 当编辑交易时，系统应当允许管理员修改记录，同时限制财务人员的权限
6. 当导出报表时，系统应当支持Excel和PDF格式的月度和年度报表

### 需求 10

**用户故事：** 作为管理员，我希望能够管理支付渠道及其配置，以便我可以控制可用的支付方式并监控其使用情况。

#### 验收标准

1. 当管理渠道时，系统应当显示渠道名称、标签、类别、启用状态和交易计数
2. 当创建渠道时，系统应当允许管理员添加包含所有必需字段的新渠道
3. 当修改渠道时，系统应当允许管理员编辑渠道属性和状态
4. 当禁用渠道时，系统应当阻止新交易，同时保留历史数据
5. 当财务人员查看时，系统应当允许对渠道信息的只读访问
6. 当处理交易时，系统应当自动更新渠道统计和余额

### 需求 11

**用户故事：** 作为管理员，我希望能够管理用户账户和角色，以便我可以控制系统访问并分配适当的权限。

#### 验收标准

1. 当管理账户时，系统应当显示用户名、角色、状态和最后登录时间
2. 当创建账户时，系统应当允许角色分配（管理员或财务人员）
3. 当编辑账户时，系统应当允许修改密码、角色和状态
4. 当禁用账户时，系统应当阻止登录，同时保留账户数据
5. 当启用账户时，系统应当恢复登录访问权限

### 需求 12

**用户故事：** 作为管理员，我希望能够配置系统级设置，以便我可以维护安全参数和系统行为。

#### 验收标准

1. 当访问设置时，系统应当显示可配置参数，包括令牌过期时间、自动登出持续时间、图片存储设置、汇率精度和日志保留期
2. 当修改设置时，系统应当要求管理员权限并验证参数值
3. 当保存设置时，系统应当在全系统范围内应用更改
4. 当财务人员访问设置时，系统应当限制访问权限

### 需求 13

**用户故事：** 作为财务人员或管理员，我希望系统能够自动计算和管理余额，以便我可以准确跟踪每种货币和支付渠道的每日余额变化。

#### 验收标准

1. 当在00:00开始新的一天时，系统应当使用公式计算新的初始金额：前一天初始金额 + 当日入账 - 当日出账
2. 当计算余额时，系统应当为每个支付渠道分别处理人民币和港币
3. 当存储余额时，系统应当将新值保存为当天的起始余额
4. 当显示实时余额时，系统应当使用公式：当前余额 = 初始金额 + 累计入账 - 累计出账
5. 当管理员配置余额时，系统应当提供手动调整初始金额的界面
6. 当调整余额时，系统应当记录调整历史和原因
7. 当查看余额趋势时，系统应当显示历史余额变化和趋势

### 需求 14

**用户故事：** 作为财务人员或管理员，我希望拥有全面的草稿管理功能，以便我可以临时保存不完整的交易记录并有效管理它们。

#### 验收标准

1. 当创建交易时，系统应当提供"保存为草稿"选项
2. 当保存草稿时，系统应当将记录存储在草稿表中，不影响正式交易数据
3. 当查看草稿时，系统应当显示所有未提交的草稿及其创建和修改时间
4. 当编辑草稿时，系统应当允许修改所有字段并重新保存
5. 当提交草稿时，系统应当验证数据，转移到正式交易表，并从草稿中删除
6. 当删除草稿时，系统应当从草稿表中永久删除记录
7. 当在00:00运行每日清理时，系统应当自动清除所有草稿记录
8. 当查看草稿详情时，系统应当显示状态、创建者、创建时间和修改历史

### 需求 15

**用户故事：** 作为系统用户，我希望所有操作都被记录和审计，以便有完整的系统活动记录用于安全和合规目的。

#### 验收标准

1. 当任何用户执行操作时，系统应当记录操作日志，包括时间戳、用户ID、操作类型和受影响的数据
2. 当发生安全事件时，系统应当记录详细的审计日志，包括登录尝试、权限更改和数据修改
3. 当访问审计日志时，系统应当为管理员提供搜索和筛选功能
4. 当日志保留期到期时，系统应当根据配置的保留策略归档或删除日志

### 需求 16

**用户故事：** 作为系统用户，我希望系统在处理大数据集时保持高性能，以便我可以无性能问题地处理交易数据。

#### 验收标准

1. 当加载交易数据时，系统应当实施分页以高效处理大数据集
2. 当导出大型报表时，系统应当支持异步导出并在完成时发送通知
3. 当多个用户同时访问时，系统应当保持响应性能
4. 当自定义显示时，系统应当保存用户偏好并一致地应用它们
5. 当上传图片时，系统应当支持自动压缩和批处理

### 需求 17

**用户故事：** 作为系统用户，我希望数据传输和存储安全，以便财务信息受到保护，免受未经授权的访问。

#### 验收标准

1. 当访问系统时，所有通信应当使用HTTPS加密
2. 当实施访问控制时，系统应当使用RBAC（基于角色的访问控制）模型
3. 当存储敏感数据时，系统应当实施适当的加密和安全措施
4. 当检测到安全威胁时，系统应当实施对策和全面日志记录
5. 当处理离线数据时，系统应当确保本地存储安全和适当的同步