# 🚀 Coding DevOps 自动构建功能说明

> 无需手动创建构建计划，代码推送后自动触发构建

## 📌 功能名称

在 Coding DevOps 中，这个功能通常称为：

1. **"代码推送自动触发"** 
2. **"基于配置文件的自动构建"**
3. **"流水线自动化"**
4. **"CI/CD 自动触发"**

## 🎯 工作原理

Coding DevOps 会自动检测代码库中的配置文件（如 `.coding-ci.yml`），当你推送代码时，系统会：

1. ✅ **自动检测** - 检测代码库中是否存在 CI/CD 配置文件
2. ✅ **自动解析** - 解析配置文件中的构建流程
3. ✅ **自动执行** - 根据配置自动触发构建任务
4. ✅ **自动报告** - 将构建结果反馈到代码仓库

---

## 📋 使用方法

### 方法一：使用 `.coding-ci.yml` 文件（推荐）

#### 1. 创建配置文件

在项目根目录创建 `.coding-ci.yml` 文件（你已经有这个文件了）：

```yaml
main:
  push:
    - name: backend
      services:
        - docker
      docker:
        image: php:8.1-fpm-alpine
      stages:
        - name: docker build
          script: ...
```

#### 2. 推送代码

```bash
git add .coding-ci.yml
git commit -m "添加 CI/CD 配置"
git push
```

#### 3. 自动触发

推送后，Coding DevOps 会：
- ✅ 自动检测到 `.coding-ci.yml` 文件
- ✅ 自动创建构建任务（第一次会提示确认）
- ✅ 自动执行构建流程

---

## 🔍 功能入口

### 查看自动构建任务

虽然不需要手动创建构建计划，但你可以在以下位置查看和管理：

```
项目 → 持续集成 → 流水线
```

或者：

```
项目 → 代码 → 提交记录 → 点击提交 SHA → 查看构建状态
```

---

## ⚙️ 配置说明

### `.coding-ci.yml` 文件位置

文件必须放在**项目根目录**：

```
项目根目录/
├── .coding-ci.yml  ← 配置文件（必须在这里）
├── backend/
├── frontend/
└── ...
```

### 文件格式

Coding DevOps 支持两种格式：

#### 1. **Coding 标准格式**（你当前使用的）

```yaml
main:
  push:
    - name: 任务名
      stages:
        - name: 阶段名
          script: ...
```

#### 2. **Jenkinsfile 格式**（可选）

如果你的项目使用 Jenkinsfile，Coding 也会自动识别：

```
Jenkinsfile
```

---

## 🎯 触发条件

### 自动触发场景

当满足以下条件时，会自动触发构建：

1. ✅ **代码推送到指定分支**
   - 默认：`master`、`main` 分支
   - 可在配置文件中指定

2. ✅ **存在配置文件**
   - `.coding-ci.yml` 存在于根目录
   - 或 `Jenkinsfile` 存在于根目录

3. ✅ **首次推送需要确认**
   - 第一次推送配置文件时，可能需要确认是否启用自动构建

---

## 📝 配置示例

### 你的项目配置（当前）

你的 `.coding-ci.yml` 文件已配置好：

```yaml
main:
  push:
    - name: backend      # 后端构建任务
      stages: [...]
    - name: nginx         # Nginx 构建任务
      stages: [...]
```

**触发条件**：
- 当代码推送到默认分支（`master`/`main`）时
- 自动执行 `backend` 和 `nginx` 两个构建任务

### 自定义触发分支

如果你想指定特定分支才触发，可以修改配置：

```yaml
main:
  push:
    branches:
      - master
      - develop
    - name: backend
      stages: [...]
```

---

## 🔧 首次使用步骤

### 1. 确保配置文件存在

检查 `.coding-ci.yml` 是否在项目根目录：

```bash
ls -la .coding-ci.yml
```

### 2. 推送代码

```bash
git add .coding-ci.yml
git commit -m "添加 CI/CD 自动构建配置"
git push origin master
```

### 3. 查看构建结果

推送后：

1. **方式 A：在代码仓库查看**
   ```
   项目 → 代码 → 提交记录
   ```
   在最新的提交旁边会显示构建状态图标（✅/❌）

2. **方式 B：在持续集成中查看**
   ```
   项目 → 持续集成 → 流水线
   ```
   会显示自动创建的构建任务和执行记录

---

## ⚠️ 注意事项

### 1. 第一次可能需要确认

首次推送 `.coding-ci.yml` 时，Coding 可能会提示：
- "检测到 CI/CD 配置文件，是否启用自动构建？"
- 选择"启用"即可

### 2. 权限要求

确保账号有权限：
- ✅ 代码仓库推送权限
- ✅ 持续集成执行权限
- ✅ 制品库推送权限（如果推送 Docker 镜像）

### 3. 配置文件语法

确保 `.coding-ci.yml` 格式正确：
- ✅ YAML 语法正确
- ✅ 缩进正确（使用空格，不要用 Tab）
- ✅ 必需字段齐全

### 4. Docker 凭证

如果使用 Docker，需要配置凭证：
- 在项目设置中配置环境变量
- 或在配置文件中直接使用（不推荐，安全性低）

---

## 🔄 与手动构建计划的区别

### 自动构建（基于配置文件）

| 特点 | 说明 |
|------|------|
| **创建方式** | 自动检测配置文件 |
| **管理方式** | 通过修改 `.coding-ci.yml` |
| **版本控制** | 配置文件随代码一起版本管理 |
| **灵活性** | 可以版本化配置，不同分支可用不同配置 |

### 手动构建计划

| 特点 | 说明 |
|------|------|
| **创建方式** | 在 Coding 界面手动创建 |
| **管理方式** | 在 Coding 界面修改 |
| **版本控制** | 配置存储在 Coding 平台 |
| **灵活性** | 需要手动同步代码更改 |

---

## 🎓 最佳实践

### 1. 配置文件版本管理

✅ **推荐**：将 `.coding-ci.yml` 提交到代码仓库
- 配置变更可追溯
- 不同分支可用不同配置
- 团队成员可以看到配置

### 2. 环境变量管理

✅ **推荐**：敏感信息使用环境变量
```yaml
script: docker login -u "$DOCKER_USER" -p "$DOCKER_PWD" ...
```
❌ **不推荐**：在配置文件中硬编码密码

### 3. 分支策略

✅ **推荐**：为不同环境配置不同触发条件
```yaml
main:
  push:
    branches:
      - master      # 生产环境
      - develop     # 开发环境
```

---

## 📚 相关文档

- **当前项目配置**: `.coding-ci.yml`
- **Docker 配置说明**: `CODING_Docker配置说明.md`
- **部署指南**: `CODING_CI_部署指南.md`
- **快速清单**: `CODING_CI_快速清单.md`

---

## 💡 总结

**你不需要手动创建构建计划！**

只需要：

1. ✅ 在项目根目录放置 `.coding-ci.yml` 文件（已有）
2. ✅ 推送代码到 Coding 仓库
3. ✅ Coding 会自动检测并执行构建

**查看构建结果**：
- 代码仓库的提交记录中
- 持续集成 → 流水线中

---

**🎉 这就是 Coding DevOps 的"代码推送自动触发构建"功能！**

每次推送代码，系统都会自动执行构建和部署流程，无需手动操作。

