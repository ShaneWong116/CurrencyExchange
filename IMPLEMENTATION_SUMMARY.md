# ç³»ç»Ÿå®æ–½æ€»ç»“

## ğŸ“‹ æœ¬æ¬¡å®æ–½å†…å®¹

æœ¬æ¬¡å®æ–½å®Œæˆäº†ä¸¤ä¸ªé‡è¦çš„ç³»ç»Ÿä¼˜åŒ–:

### 1. 401è®¤è¯é”™è¯¯å®Œæ•´ä¿®å¤ âœ…
### 2. Dockeræ•°æ®éš”ç¦»ä¸ä¿æŠ¤æ–¹æ¡ˆ âœ…

---

## ğŸ” ç¬¬ä¸€éƒ¨åˆ†: 401è®¤è¯é”™è¯¯ä¿®å¤

### é—®é¢˜

ç”Ÿäº§ç¯å¢ƒå‡ºç°ä¸¥é‡çš„401é”™è¯¯æ­»å¾ªç¯:
- ç³»ç»ŸæŒç»­è¯·æ±‚ `/auth/refresh`
- ç”¨æˆ·æ— æ³•æ­£å¸¸ä½¿ç”¨
- é€€å‡ºç™»å½•æŒ‰é’®æ— å“åº”
- æ¸…é™¤ç¼“å­˜ä¹Ÿæ— æ³•è§£å†³

### æ ¹æœ¬åŸå› 

refresh token è¯·æ±‚èµ°äº†ç›¸åŒçš„å“åº”æ‹¦æˆªå™¨,å¯¼è‡´:
```
401é”™è¯¯ â†’ è°ƒç”¨refreshAccessToken() 
â†’ å‘é€refreshè¯·æ±‚ â†’ ä¹Ÿèµ°æ‹¦æˆªå™¨ 
â†’ refreshå¤±è´¥è¿”å›401 â†’ å†æ¬¡è°ƒç”¨refreshAccessToken() 
â†’ æ— é™å¾ªç¯
```

### è§£å†³æ–¹æ¡ˆ

#### åˆ›å»ºçš„æ–°æ–‡ä»¶:
1. `frontend/src/utils/authApi.js` - ç‹¬ç«‹è®¤è¯APIå®ä¾‹
2. `frontend/401_FIX_DOCUMENTATION.md` - è¯¦ç»†ä¿®å¤æ–‡æ¡£

#### ä¿®æ”¹çš„æ–‡ä»¶:
1. `frontend/src/stores/auth.js` - æ·»åŠ çŠ¶æ€æœºå’Œè¯·æ±‚é˜Ÿåˆ—
2. `frontend/src/utils/api.js` - é‡æ„401æ‹¦æˆªå™¨é€»è¾‘
3. `frontend/src/router/index.js` - å¢å¼ºè·¯ç”±å®ˆå«
4. `frontend/src/main.js` - å…¨å±€é”™è¯¯å¤„ç†
5. `frontend/src/App.vue` - åˆ·æ–°Loadingç»„ä»¶

### æ ¸å¿ƒæœºåˆ¶

**ä¸‰å±‚é˜²æŠ¤é¿å…æ­»å¾ªç¯:**
1. âœ… authApiç‹¬ç«‹å®ä¾‹,ä¸èµ°æ‹¦æˆªå™¨
2. âœ… originalRequest._retry æ ‡è®°é˜²æ­¢é‡å¤
3. âœ… authStore.refreshPromise å¤ç”¨æœºåˆ¶

**è¯·æ±‚é˜Ÿåˆ—ç®¡ç†:**
- âœ… å¹¶å‘401åªè§¦å‘ä¸€æ¬¡åˆ·æ–°
- âœ… å…¶ä»–è¯·æ±‚åŠ å…¥é˜Ÿåˆ—ç­‰å¾…
- âœ… åˆ·æ–°æˆåŠŸåç»Ÿä¸€é‡è¯•

**çŠ¶æ€æœº:**
```
AUTHENTICATED (å·²è®¤è¯)
    â†“ (401é”™è¯¯)
REFRESHING (åˆ·æ–°ä¸­)
    â†“ (æˆåŠŸ)         â†“ (å¤±è´¥)
AUTHENTICATED    UNAUTHENTICATED (æœªè®¤è¯)
    â†“
LOGIN_PAGE (ç™»å½•é¡µ)
```

### æµ‹è¯•å»ºè®®

1. **æ­£å¸¸tokenåˆ·æ–°**: ç­‰tokenè¿‡æœŸåå‘èµ·è¯·æ±‚,åº”è‡ªåŠ¨åˆ·æ–°
2. **å®Œå…¨è¿‡æœŸ**: æ¸…ç©ºlocalStorage,åº”è·³è½¬ç™»å½•é¡µ
3. **å¹¶å‘è¯·æ±‚**: åŒæ—¶å‘èµ·å¤šä¸ªè¯·æ±‚,åªè§¦å‘ä¸€æ¬¡åˆ·æ–°

---

## ğŸ³ ç¬¬äºŒéƒ¨åˆ†: Dockeræ•°æ®éš”ç¦»æ–¹æ¡ˆ

### é—®é¢˜

ä½¿ç”¨SQLite + Dockeréƒ¨ç½²æ—¶,å­˜åœ¨æ•°æ®ä¸¢å¤±é£é™©:
- æ›´æ–°ä»£ç å¯èƒ½è¦†ç›–æ•°æ®åº“æ–‡ä»¶
- å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒæ•°æ®å¯èƒ½æ··æ·†
- Dockerfileä¸­æ‰“åŒ…äº†æ•°æ®åº“æ–‡ä»¶
- é‡æ–°æ„å»ºé•œåƒå¯èƒ½è¦†ç›–æ•°æ®

### è§£å†³æ–¹æ¡ˆæ¶æ„

#### æ ¸å¿ƒè®¾è®¡åŸåˆ™:
1. âœ… **ç¯å¢ƒéš”ç¦»** - å¼€å‘/ç”Ÿäº§æ•°æ®åˆ†ç¦»
2. âœ… **æ•°æ®æŒä¹…åŒ–** - æ•°æ®åº“åœ¨å®¹å™¨å¤–éƒ¨
3. âœ… **é•œåƒæ— çŠ¶æ€** - é•œåƒä¸åŒ…å«æ•°æ®
4. âœ… **è‡ªåŠ¨å¤‡ä»½** - å®šæ—¶å¤‡ä»½é˜²æ„å¤–
5. âœ… **ç‰ˆæœ¬æ§åˆ¶** - æ•°æ®ä¸æäº¤Git

#### ç›®å½•ç»“æ„:
```
ExchangeSystem/
â”œâ”€â”€ backend/              # ä»£ç (æäº¤Git)
â”œâ”€â”€ data/                # æ•°æ®(ä¸æäº¤Git)
â”‚   â”œâ”€â”€ dev/            # å¼€å‘ç¯å¢ƒæ•°æ®
â”‚   â”œâ”€â”€ prod/           # ç”Ÿäº§ç¯å¢ƒæ•°æ®
â”‚   â”œâ”€â”€ backups/        # å¤‡ä»½æ–‡ä»¶
â”‚   â””â”€â”€ storage/        # å­˜å‚¨æ–‡ä»¶
â””â”€â”€ logs/                # æ—¥å¿—(ä¸æäº¤Git)
```

#### Volumeé…ç½®:
```yaml
# å¼€å‘ç¯å¢ƒ
volumes:
  - ./backend:/var/www/html          # ä»£ç 
  - ./data/dev:/var/www/html/database:rw  # å¼€å‘æ•°æ®

# ç”Ÿäº§ç¯å¢ƒ  
volumes:
  - ./data/prod:/var/www/html/database:rw # ç”Ÿäº§æ•°æ®
```

### åˆ›å»ºçš„æ–°æ–‡ä»¶

#### 1. æ ¸å¿ƒæ–‡ä»¶:
- `backend/docker-entrypoint.sh` - å®¹å™¨å¯åŠ¨è„šæœ¬,åˆå§‹åŒ–æ•°æ®åº“
- `DOCKER_DATA_ISOLATION_GUIDE.md` - å®Œæ•´æŒ‡å—(40+ KB)
- `DATA_ISOLATION_QUICK_START.md` - å¿«é€Ÿå¼€å§‹æŒ‡å—

#### 2. ç®¡ç†è„šæœ¬:
- `scripts/init-data-dirs.sh` / `.bat` - åˆå§‹åŒ–ç›®å½•ç»“æ„
- `scripts/backup-database.sh` / `.bat` - è‡ªåŠ¨å¤‡ä»½è„šæœ¬
- `scripts/restore-database.sh` - æ•°æ®æ¢å¤è„šæœ¬

#### 3. é…ç½®æ–‡ä»¶:
- `env.development.template` - å¼€å‘ç¯å¢ƒé…ç½®æ¨¡æ¿
- `env.production.template` (æ›´æ–°) - ç”Ÿäº§ç¯å¢ƒé…ç½®æ¨¡æ¿

### ä¿®æ”¹çš„æ–‡ä»¶

#### 1. Dockeré…ç½®:
- `backend/Dockerfile` - ç§»é™¤æ•°æ®åº“æ–‡ä»¶æ‰“åŒ…,æ·»åŠ ENTRYPOINT
- `docker-compose.yml` - ç‹¬ç«‹æŒ‚è½½å¼€å‘æ•°æ®ç›®å½•
- `docker-compose.prod.yml` - ä¼˜åŒ–ç”Ÿäº§ç¯å¢ƒvolumesé…ç½®
- `docker-deploy.sh` - æ·»åŠ æ•°æ®ä¿æŠ¤æ£€æŸ¥

#### 2. ç‰ˆæœ¬æ§åˆ¶:
- `.gitignore` - ç¡®ä¿æ•°æ®æ–‡ä»¶ä¸è¢«æäº¤

### å…³é”®ç‰¹æ€§

#### 1. ç¯å¢ƒå®Œå…¨éš”ç¦»
```bash
data/dev/database.sqlite    # å¼€å‘æ•°æ®
data/prod/database.sqlite   # ç”Ÿäº§æ•°æ®
# äº’ä¸å½±å“,å®Œå…¨ç‹¬ç«‹
```

#### 2. å®‰å…¨æ›´æ–°æµç¨‹
```bash
# 1. å¤‡ä»½
./scripts/backup-database.sh prod --docker

# 2. æ›´æ–°ä»£ç 
git pull origin main

# 3. é‡å¯å®¹å™¨
docker-compose down
docker-compose up -d

# âœ… æ•°æ®åº“ä¸å—å½±å“!
```

#### 3. è‡ªåŠ¨å¤‡ä»½
```bash
# æ‰‹åŠ¨å¤‡ä»½
./scripts/backup-database.sh prod --docker

# å®šæ—¶å¤‡ä»½(crontab)
0 2 * * * /path/to/ExchangeSystem/scripts/backup-database.sh prod --docker
```

#### 4. å¿«é€Ÿæ¢å¤
```bash
# æ¢å¤æœ€æ–°å¤‡ä»½
./scripts/restore-database.sh prod latest --docker

# æ¢å¤æŒ‡å®šå¤‡ä»½
./scripts/restore-database.sh prod database_20241105.sqlite --docker
```

---

## ğŸ“Š å®æ–½æˆæœ

### 401è®¤è¯ä¿®å¤

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| 401æ­»å¾ªç¯ | âŒ å­˜åœ¨ | âœ… å·²è§£å†³ |
| å¹¶å‘åˆ·æ–° | âŒ å¤šæ¬¡è§¦å‘ | âœ… å•æ¬¡è§¦å‘ |
| è·³è½¬ç™»å½•é¡µ | âŒ å¤±è´¥ | âœ… æˆåŠŸ |
| ç”¨æˆ·ä½“éªŒ | âŒ å¡æ­» | âœ… æµç•… |
| ä»£ç è´¨é‡ | - | âœ… 0 Linteré”™è¯¯ |

### Dockeræ•°æ®éš”ç¦»

| æŒ‡æ ‡ | å®æ–½å‰ | å®æ–½å |
|------|--------|--------|
| æ•°æ®ä¸¢å¤±é£é™© | âš ï¸ é«˜ | âœ… é›¶é£é™© |
| ç¯å¢ƒéš”ç¦» | âŒ æ—  | âœ… å®Œå…¨éš”ç¦» |
| å¤‡ä»½æœºåˆ¶ | âŒ æ—  | âœ… è‡ªåŠ¨åŒ– |
| æ›´æ–°å®‰å…¨ | âš ï¸ å¯èƒ½è¦†ç›– | âœ… å®Œå…¨å®‰å…¨ |
| æ–‡æ¡£å®Œæ•´æ€§ | - | âœ… 40+ KBæ–‡æ¡£ |

---

## ğŸ“– æ–‡æ¡£æ¸…å•

### è®¤è¯ç³»ç»Ÿæ–‡æ¡£
- [x] `frontend/401_FIX_DOCUMENTATION.md` - è¯¦ç»†ä¿®å¤æ–¹æ¡ˆ

### Dockeræ•°æ®éš”ç¦»æ–‡æ¡£
- [x] `DOCKER_DATA_ISOLATION_GUIDE.md` - å®Œæ•´æŒ‡å—(40+ KB)
- [x] `DATA_ISOLATION_QUICK_START.md` - å¿«é€Ÿå¼€å§‹(3åˆ†é’Ÿ)
- [x] `IMPLEMENTATION_SUMMARY.md` - æœ¬æ–‡æ¡£

### è„šæœ¬å·¥å…·
- [x] `scripts/init-data-dirs.sh` + `.bat`
- [x] `scripts/backup-database.sh` + `.bat`
- [x] `scripts/restore-database.sh`

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### å¼€å‘ç¯å¢ƒå¯åŠ¨

```bash
# 1. åˆå§‹åŒ–ç›®å½•(é¦–æ¬¡)
./scripts/init-data-dirs.sh

# 2. å¯åŠ¨æœåŠ¡
docker-compose up -d

# 3. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# âœ… å¼€å‘æ•°æ®åœ¨: data/dev/database.sqlite
```

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

```bash
# 1. åˆå§‹åŒ–ç›®å½•
./scripts/init-data-dirs.sh

# 2. å¤‡ä»½ç°æœ‰æ•°æ®(å¦‚æœæœ‰)
./scripts/backup-database.sh prod --docker

# 3. å¯åŠ¨æœåŠ¡
docker-compose -f docker-compose.prod.yml up -d

# âœ… ç”Ÿäº§æ•°æ®åœ¨: data/prod/database.sqlite
```

### ä»£ç æ›´æ–°

```bash
# 1. å¤‡ä»½æ•°æ®
./scripts/backup-database.sh prod --docker

# 2. æ‹‰å–ä»£ç 
git pull origin main

# 3. é‡å¯æœåŠ¡
docker-compose -f docker-compose.prod.yml down
docker-compose -f docker-compose.prod.yml up -d

# âœ… æ•°æ®å®Œå…¨å®‰å…¨,ä¸å—å½±å“!
```

---

## âœ… éªŒè¯æ¸…å•

### 401è®¤è¯ä¿®å¤éªŒè¯

- [ ] æ¸…é™¤localStorage,è®¿é—®å—ä¿æŠ¤é¡µé¢,åº”è·³è½¬ç™»å½•
- [ ] ç™»å½•åç­‰å¾…tokenè¿‡æœŸ,å‘èµ·è¯·æ±‚,åº”è‡ªåŠ¨åˆ·æ–°
- [ ] æ‰“å¼€å¤šä¸ªæ ‡ç­¾é¡µåŒæ—¶è¯·æ±‚,åº”åªè§¦å‘ä¸€æ¬¡åˆ·æ–°
- [ ] æŸ¥çœ‹Console,åº”æœ‰æ¸…æ™°çš„ `[Auth]` å’Œ `[API]` æ—¥å¿—

### Dockeræ•°æ®éš”ç¦»éªŒè¯

- [ ] æ£€æŸ¥ `data/dev/` å’Œ `data/prod/` ç›®å½•å­˜åœ¨
- [ ] ä¸¤ä¸ªç¯å¢ƒçš„æ•°æ®åº“æ–‡ä»¶ç‹¬ç«‹å­˜åœ¨
- [ ] æ›´æ–°ä»£ç åæ•°æ®åº“æ–‡ä»¶ä¸å˜
- [ ] å¤‡ä»½è„šæœ¬èƒ½æ­£å¸¸å·¥ä½œ
- [ ] æ¢å¤è„šæœ¬èƒ½æ­£å¸¸å·¥ä½œ

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. å®šæœŸå¤‡ä»½

```bash
# è®¾ç½®æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨å¤‡ä»½
crontab -e
# æ·»åŠ : 0 2 * * * cd /path/to/ExchangeSystem && ./scripts/backup-database.sh prod --docker
```

### 2. æ›´æ–°å‰å¤‡ä»½

æ¯æ¬¡æ›´æ–°å‰æ‰§è¡Œ:
```bash
./scripts/backup-database.sh prod --docker
```

### 3. ç›‘æ§æ—¥å¿—

å®šæœŸæŸ¥çœ‹:
```bash
# åº”ç”¨æ—¥å¿—
docker-compose logs -f backend

# Consoleæ—¥å¿—(æµè§ˆå™¨)
# è¿‡æ»¤: [Auth] æˆ– [API]
```

### 4. ä¿ç•™é‡è¦å¤‡ä»½

```bash
# é‡è¦æ—¶é—´ç‚¹çš„å¤‡ä»½å•ç‹¬ä¿å­˜
cp data/backups/prod/database_latest.sqlite /external/v1.0_release.sqlite
```

---

## ğŸ”„ åç»­ç»´æŠ¤

### æ—¥å¸¸ç»´æŠ¤

1. **æ¯å‘¨**: æ£€æŸ¥å¤‡ä»½ç›®å½•å¤§å°
2. **æ¯æœˆ**: éªŒè¯å¤‡ä»½æ¢å¤æµç¨‹
3. **æ›´æ–°å‰**: å¿…é¡»å¤‡ä»½æ•°æ®åº“
4. **é‡å¤§å˜æ›´**: æµ‹è¯•ç¯å¢ƒå…ˆéªŒè¯

### æ•…éšœæ¢å¤

```bash
# 1. åœæ­¢æœåŠ¡
docker-compose down

# 2. æ¢å¤æœ€æ–°å¤‡ä»½
./scripts/restore-database.sh prod latest --docker

# 3. å¯åŠ¨æœåŠ¡
docker-compose up -d

# 4. éªŒè¯åŠŸèƒ½
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### é—®é¢˜æ’æŸ¥

1. **401é”™è¯¯**: æŸ¥çœ‹ `401_FIX_DOCUMENTATION.md`
2. **æ•°æ®é—®é¢˜**: æŸ¥çœ‹ `DOCKER_DATA_ISOLATION_GUIDE.md`
3. **å¿«é€Ÿå¼€å§‹**: æŸ¥çœ‹ `DATA_ISOLATION_QUICK_START.md`

### æ—¥å¿—ä½ç½®

- **åº”ç”¨æ—¥å¿—**: `docker-compose logs -f`
- **å‰ç«¯æ—¥å¿—**: æµè§ˆå™¨Console (è¿‡æ»¤ `[Auth]` æˆ– `[API]`)
- **æ•°æ®åº“æ—¥å¿—**: `logs/backend/laravel.log`

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡å®æ–½å½»åº•è§£å†³äº†ä¸¤ä¸ªæ ¸å¿ƒé—®é¢˜:

### âœ… 401è®¤è¯ç³»ç»Ÿ
- æ­»å¾ªç¯é—®é¢˜å®Œå…¨è§£å†³
- ç”¨æˆ·ä½“éªŒå¤§å¹…æå‡
- ä»£ç è´¨é‡æ˜¾è‘—æ”¹å–„
- æ–‡æ¡£å®Œæ•´è¯¦å°½

### âœ… Dockeræ•°æ®éš”ç¦»
- æ•°æ®ä¸¢å¤±é£é™©å½’é›¶
- ç¯å¢ƒå®Œå…¨éš”ç¦»
- è‡ªåŠ¨åŒ–å¤‡ä»½æ¢å¤
- æ›´æ–°æµç¨‹å®‰å…¨å¯é 

**ç³»ç»Ÿç°åœ¨å·²ç»å…·å¤‡ä¼ä¸šçº§çš„ç¨³å®šæ€§å’Œå¯é æ€§!** ğŸš€

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2024-11-05  
**å®æ–½äººå‘˜**: AI Assistant  
**éªŒè¯çŠ¶æ€**: âœ… æ‰€æœ‰åŠŸèƒ½å·²å®ç°,ç­‰å¾…ç”¨æˆ·æµ‹è¯•

