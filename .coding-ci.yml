# ============================================
# Coding CI/CD é…ç½®æ–‡ä»¶
# Exchange System - Docker é•œåƒæž„å»ºä¸Žå‘å¸ƒ
# ============================================

main:
  push:
    # ============================================
    # ä»»åŠ¡1: æž„å»ºåŽç«¯é•œåƒ
    # ============================================
    - name: backend
      services:
        - docker  # å£°æ˜ŽåŽï¼Œæµæ°´çº¿å†…å¯ä»¥ç›´æŽ¥ä½¿ç”¨ docker å‘½ä»¤
      docker:
        image: php:8.1-fpm-alpine  # PHP åŸºç¡€é•œåƒç”¨äºŽæž„å»º
      stages:
        # è®¾ç½® Docker é•œåƒæ ‡ç­¾
        - name: set docker tag
          script: echo -n "zhlibai-docker.pkg.coding.net/currencyexchange/exchange-system/backend:$CODING_COMMIT_SHORT"
          exports:
            info: IMAGE_TAG

        # æž„å»º Docker é•œåƒ
        - name: docker build backend
          script:
            - cd backend
            - echo "ðŸ—ï¸ æž„å»ºåŽç«¯é•œåƒ..."
            - docker build --no-cache -t $IMAGE_TAG -t zhlibai-docker.pkg.coding.net/currencyexchange/exchange-system/backend:latest .
            - echo "âœ… åŽç«¯é•œåƒæž„å»ºå®Œæˆ"

        # Docker ç™»å½•
        - name: docker login
          script: docker login -u currencyexchange-1762153618987 -p f2ed7fac940b86ac8b194be3a71798c81f628c08 zhlibai-docker.pkg.coding.net

        # æŽ¨é€é•œåƒ
        - name: push backend image
          script:
            - echo "ðŸ“¤ æŽ¨é€åŽç«¯é•œåƒ..."
            - docker push $IMAGE_TAG && docker push zhlibai-docker.pkg.coding.net/currencyexchange/exchange-system/backend:latest
            - echo "âœ… åŽç«¯é•œåƒæŽ¨é€å®Œæˆ"
            - echo "é•œåƒåœ°å€:"
            - echo "  - $IMAGE_TAG"
            - echo "  - zhlibai-docker.pkg.coding.net/currencyexchange/exchange-system/backend:latest"

    # ============================================
    # ä»»åŠ¡2: æž„å»ºå‰ç«¯å¹¶æ‰“åŒ… Nginx é•œåƒ
    # ============================================
    - name: nginx
      services:
        - docker  # å£°æ˜ŽåŽï¼Œæµæ°´çº¿å†…å¯ä»¥ç›´æŽ¥ä½¿ç”¨ docker å‘½ä»¤
      docker:
        image: node:18-alpine  # Node.js åŸºç¡€é•œåƒç”¨äºŽæž„å»ºå‰ç«¯
      stages:
        # æž„å»ºå‰ç«¯åº”ç”¨
        - name: build frontend
          script:
            - echo "ðŸ“± æž„å»ºå‰ç«¯åº”ç”¨..."
            - cd frontend
            - npm install
            - npm run build
            - echo "âœ… å‰ç«¯æž„å»ºå®Œæˆ"
            - ls -la dist/

        # åˆ›å»º Nginx Dockerfile
        - name: create nginx dockerfile
          script:
            - cd ..  # è¿”å›žé¡¹ç›®æ ¹ç›®å½•
            - echo "ðŸ“ åˆ›å»º Nginx Dockerfile..."
            - |
              cat > Dockerfile.nginx <<EOF
              FROM nginx:alpine
              
              # å®‰è£… wget ç”¨äºŽå¥åº·æ£€æŸ¥
              RUN apk add --no-cache wget
              
              # å¤åˆ¶å‰ç«¯æž„å»ºäº§ç‰©
              COPY frontend/dist /var/www/html/frontend
              
              # å¤åˆ¶ Nginx é…ç½®
              COPY docker/nginx/conf.d /etc/nginx/conf.d
              
              # è®¾ç½®æƒé™
              RUN chmod -R 755 /var/www/html
              
              # å¥åº·æ£€æŸ¥
              HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
                CMD wget --no-verbose --tries=1 --spider http://localhost || exit 1
              
              EXPOSE 80 443
              
              CMD ["nginx", "-g", "daemon off;"]
              EOF
            - echo "âœ… Dockerfile åˆ›å»ºå®Œæˆ"

        # è®¾ç½® Docker é•œåƒæ ‡ç­¾
        - name: set docker tag
          script: echo -n "zhlibai-docker.pkg.coding.net/currencyexchange/exchange-system/nginx:$CODING_COMMIT_SHORT"
          exports:
            info: IMAGE_TAG

        # æž„å»º Nginx Docker é•œåƒ
        - name: docker build nginx
          script:
            - echo "ðŸ—ï¸ æž„å»º Nginx é•œåƒ..."
            - pwd  # æ˜¾ç¤ºå½“å‰ç›®å½•
            - echo "æ£€æŸ¥å‰ç«¯æž„å»ºäº§ç‰©..."
            - ls -la frontend/dist/ || (echo "âŒ å‰ç«¯æž„å»ºäº§ç‰©ä¸å­˜åœ¨" && exit 1)
            - echo "æ£€æŸ¥ Nginx é…ç½®æ–‡ä»¶..."
            - ls -la docker/nginx/conf.d/ || (echo "âŒ Nginx é…ç½®æ–‡ä»¶ä¸å­˜åœ¨" && exit 1)
            - echo "æ£€æŸ¥ Dockerfile.nginx..."
            - ls -la Dockerfile.nginx || (echo "âŒ Dockerfile.nginx ä¸å­˜åœ¨" && exit 1)
            - docker build --no-cache -f Dockerfile.nginx -t $IMAGE_TAG -t zhlibai-docker.pkg.coding.net/currencyexchange/exchange-system/nginx:latest .
            - echo "âœ… Nginx é•œåƒæž„å»ºå®Œæˆ"

        # Docker ç™»å½•
        - name: docker login
          script: docker login zhlibai-docker.pkg.coding.net -u "$DOCKER_USER" -p "$DOCKER_PWD"

        # æŽ¨é€é•œåƒ
        - name: push nginx image
          script:
            - echo "ðŸ“¤ æŽ¨é€ Nginx é•œåƒ..."
            - docker push $IMAGE_TAG && docker push zhlibai-docker.pkg.coding.net/currencyexchange/exchange-system/nginx:latest
            - echo "âœ… Nginx é•œåƒæŽ¨é€å®Œæˆ"
            - echo "é•œåƒåœ°å€:"
            - echo "  - $IMAGE_TAG"
            - echo "  - zhlibai-docker.pkg.coding.net/currencyexchange/exchange-system/nginx:latest"
