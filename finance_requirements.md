
# 财务类项目前台需求文档
（外勤人员端）

## 1. 项目概述
本系统为财务业务的外勤人员提供**交易录入、兑换记录、草稿管理** 功能。
前台以移动端优先设计，支持离线工作，最终数据需同步至后台数据库。

## 2. 用户与权限
- **外勤人员**（仅前台用户）  
- 账号由后台创建，用户通过 **账号+密码** 登录  
- 不支持注册和找回密码，账号管理在后台完成  

## 3. 功能需求

### 3.1 登录与安全
- **登录**  
  - 登录方式：账号 + 密码  
  - 登录成功后获取 Token（Access Token + Refresh Token）  
  - 登录失败时提示错误信息  

- **自动登出**  
  - 前端：监听用户操作，无操作超过 **15 分钟** → 自动登出  
  - 登出前 **1 分钟弹出提醒**，用户可点击“保持登录”延长会话  
  - 后端：Access Token 30 分钟过期，Refresh Token 7 天有效  
  - 登出后需清理本地 Token，草稿与提交队列数据保留  

### 3.2 首页
登录后显示两个入口：  
1. **交易录入**  
2. **编辑草稿**

### 3.3 交易录入  
分为两个子页面（通过底部导航切换）：**录入** 与 **兑换**。

#### 3.3.1 录入页
- **字段**  
  - 交易类型（必填）：入账 / 出账  
    - **入账**：人民币增加(+)，港币减少(-)  
    - **出账**：人民币减少(-)，港币增加(+)  
  - 人民币金额（必填）：输入金额数值  
  - 港币金额（必填）：输入金额数值  
  - 汇率（必填）：手动输入，保留 5 位小数，四舍五入  
  - 渠道（必填）：下拉选择（后台维护渠道列表）  
  - 图片上传（非必填）：相册/相机，多张支持  

- **操作按钮**  
  - 录入（提交）  
  - 存为草稿  

#### 3.3.2 兑换页
- **字段**  
  - 人民币金额（必填）  
  - 港币金额（必填）  
  - 即时汇率：系统自动计算（港币/人民币，保留 5 位小数，四舍五入）  
  - 交易汇率（必填）：手动输入，保留 5 位小数，四舍五入  

- **操作按钮**  
  - 录入（提交）  
  - 存为草稿  

### 3.4 草稿管理
- **草稿列表**  
  - 展示所有未提交的草稿  
  - 字段：草稿类型、金额、渠道、最后修改时间  
- **草稿编辑**  
  - 点击进入 → 回显数据 → 修改后可提交或继续保存  
  - 提交成功后 → 草稿状态更新并同步至后台  

### 3.5 离线提交队列
- **存储机制**  
  - 草稿：本地数据库（SQLite/IndexedDB）+ 云端存储（后台数据库）  
  - 提交队列：本地保存“待上传记录”（状态=待提交）  

- **流程**  
  1. 用户点击录入 → 若有网络，直接提交至后台  
  2. 若无网络 → 保存到本地提交队列（状态 pending）  
  3. 网络恢复 → 自动检测并批量上传  
  4. 上传成功 → 状态更新为 success  
  5. 上传失败 → 状态更新为 failed，用户可手动重试  

- **图片处理**  
  - 离线时存本地路径  
  - 上传时先提交文字数据，后台返回 recordId，再分批上传图片  

- **冲突解决**  
  - 使用 `uuid` 保证幂等性  
  - 以 `lastModified` 时间戳判断最新版本  

## 4. 数据存储与后台接口

### 4.1 数据结构（示例）
```json
{
  "id": "uuid",
  "userId": "12345",
  "type": "income/outcome/exchange",
  "rmbAmount": "100.00",
  "hkdAmount": "120.00",
  "channelId": "CH001",
  "exchangeRate": "1.20000",
  "instantRate": "1.20450",
  "images": ["url1", "url2"],
  "status": "draft/pending/success/failed",
  "createdAt": "2025-09-04T20:30:00Z",
  "lastModified": "2025-09-04T20:31:00Z"
}
```

### 4.2 后台数据库设计建议
- `transactions`：存储所有正式交易  
- `drafts`：存储草稿（与 userId 绑定）  
- `channels`：渠道配置表（后台维护）  
- `audit_logs`：日志表（记录所有提交/修改）  

## 5. 非功能需求
- **安全性**  
  - 全站 HTTPS  
  - Access Token + Refresh Token 鉴权  
  - 自动登出机制  

- **可用性**  
  - 支持离线录入和批量上传  
  - 界面移动端优先，简洁直观  

- **性能**  
  - 批量上传支持断点续传  
  - 图片上传自动压缩  

## 6. 用户流程图（简要）

```
登录 → 首页
         ├─ 交易录入
         │     ├─ 录入页（入账/出账）
         │     └─ 兑换页（汇率）
         └─ 编辑草稿
                └─ 草稿详情（修改/提交）
提交 → 本地存队列 → (有网)上传 → 后台入库
                      (无网)待提交 → 网络恢复 → 批量上传
```

## 7. 技术栈选型

### 7.1 前端技术栈
- **框架**：Vue.js 3 + Quasar Framework
  - Vue 3：现代响应式框架，组件化开发
  - Quasar：跨平台 UI 框架，一套代码多端部署
  - 支持 PWA、移动端原生功能调用

- **移动端解决方案**：PWA + Capacitor
  - PWA：离线缓存、推送通知、类原生体验
  - Capacitor：调用原生功能（相机、相册、存储）
  - 响应式设计，适配各种屏幕尺寸

- **本地存储**：IndexedDB + LocalStorage
  - IndexedDB：存储草稿、离线队列、大量数据
  - LocalStorage：用户设置、Token、简单配置
  - 支持事务操作，保证数据一致性

- **状态管理**：Pinia
  - Vue 3 官方推荐状态管理库
  - 模块化管理应用状态
  - 支持持久化存储

### 7.2 开发工具
- **构建工具**：Vite + Vue CLI
- **代码规范**：ESLint + Prettier
- **版本控制**：Git + GitFlow
- **调试工具**：Vue DevTools

### 7.3 离线功能实现
- **Service Worker**：缓存策略、后台同步
- **数据同步**：网络检测、队列管理、重试机制
- **冲突解决**：UUID 幂等性、时间戳版本控制
