# 货币交换系统需求整理

## 一、系统概述

本系统是一个货币交换系统，将**人民币作为"商品"**进行交易管理，核心功能包括交易记录、渠道余额管理和结余结算。

---

## 二、交易类型

### 2.1 入账交易
**业务含义**：收入人民币（商品），该批人民币的价值为港币金额

**输入字段**：
- 人民币金额：收入的人民币数量
- 港币金额：该批人民币的价值（港币计价）
- 汇率：人民币金额 ÷ 港币金额
- 渠道：交易渠道

**业务逻辑**：
1. 记录交易详情（人民币金额、港币金额、汇率、渠道、交易时间等）
2. 对应渠道的人民币余额增加（+人民币金额）
3. 交易状态初始为"未结余"
4. **不影响港币结余**（港币结余仅在结余时更新）

---

### 2.2 出账交易
**业务含义**：支出人民币（商品），该批人民币的价值为港币金额

**输入字段**：
- 人民币金额：支出的人民币数量
- 港币金额：该批人民币的价值（港币计价）
- 汇率：人民币金额 ÷ 港币金额
- 渠道：交易渠道

**业务逻辑**：
1. 记录交易详情（人民币金额、港币金额、汇率、渠道、交易时间等）
2. 对应渠道的人民币余额减少（-人民币金额）
3. 交易状态初始为"未结余"
4. **不影响港币结余**（港币结余仅在结余时更新）

---

### 2.3 即时买断交易
**说明**：该功能暂不实现，待入账、出账功能完善后再补充设计

---

## 三、结余功能

### 3.1 操作流程
1. 点击"结余"按钮
2. 系统显示结余预览（包含各项计算数据）
3. 用户填写"其他支出"（可选）
4. 确认结余，系统执行结余操作并显示结余后的详细信息

### 3.2 结余预览信息

#### (1) 本金
- **定义**：全局可编辑变量（港币金额）
- **初始化**：系统首次使用时手动输入
- **更新规则**：每次结余后，本金 = 原本金 + 利润 - 其他支出
- **作用**：作为下一次结余的初始本金

#### (1.5) 港币结余
- **定义**：全局变量（港币金额）
- **初始化**：系统首次使用时手动输入
- **更新规则**：每次结余后，港币结余 = 原港币结余 + 利润
- **重要说明**：入账、出账交易**不影响**港币结余，仅结余时更新

#### (2) 当前结余汇率
**计算公式**：
```
当前结余汇率 = 人民币总量 ÷ 港币总量

其中：
人民币总量 = 当前各渠道人民币余额汇总 + 未结余入账人民币金额之和
港币总量 = 当前港币结余 + 未结余入账港币金额之和
```

**说明**：
- 当前各渠道人民币余额汇总：所有渠道的人民币余额之和
- 未结余入账人民币金额之和：状态为"未结余" + 类型为"入账"的交易的人民币金额总和
- 当前港币结余：系统维护的港币余额（全局变量）
- 未结余入账港币金额之和：状态为"未结余" + 类型为"入账"的交易的港币金额总和

#### (3) 利润
**计算公式**：
```
利润 = 当前未结余的出账港币总额 - 当前未结余的出账港币成本

其中：
当前未结余的出账港币总额 = SUM(状态为"未结余" AND 类型为"出账"的港币金额)
当前未结余的出账港币成本 = (SUM(状态为"未结余" AND 类型为"出账"的人民币金额)) ÷ 当前结余汇率
```

**说明**：
- 出账港币总额：实际收到的港币
- 出账港币成本：出账人民币按当前结余汇率折算的港币价值
- 利润 = 收入 - 成本

#### (4) 人民币余额
- 当前各渠道人民币余额的汇总

#### (5) 结余后本金
**计算公式**：
```
结余后本金 = 当前本金 + 利润 - 其他支出
```

#### (6) 结余后港币结余
**计算公式**：
```
结余后港币结余 = 当前港币结余 + 利润
```

### 3.3 其他支出明细
根据参考表格，其他支出需要显示详细分类，包括但不限于：
- 项目：支出项目名称（如：资金、薪金、金流费用、旺金、电费、化红等）
- 金额：各项支出的具体金额
- 总支出：所有其他支出的汇总

**界面要求**：
- 结余预览时可以输入多项其他支出
- 每项支出需要记录项目名称和金额
- 结余后的结余页面需要完整展示所有其他支出明细

---

## 四、数据结构设计建议

### 4.1 交易表（transactions）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | 主键 | 交易ID |
| type | 枚举 | 交易类型：入账/出账 |
| rmb_amount | 数值 | 人民币金额 |
| hkd_amount | 数值 | 港币金额 |
| exchange_rate | 数值 | 汇率 |
| channel_id | 外键 | 渠道ID |
| settlement_status | 枚举 | 结余状态：已结余/未结余 |
| settlement_id | 外键 | 所属结余批次ID（已结余时） |
| created_at | 时间戳 | 交易时间 |

### 4.2 渠道表（channels）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | 主键 | 渠道ID |
| name | 字符串 | 渠道名称 |
| rmb_balance | 数值 | 人民币余额 |

### 4.3 系统设置表（settings）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| key | 主键 | 设置项键名 |
| value | 数值 | 设置项值 |

**关键设置项**：
- `capital`：当前本金
- `hkd_balance`：当前港币结余

### 4.4 结余记录表（settlements）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | 主键 | 结余ID |
| previous_capital | 数值 | 结余前本金 |
| previous_hkd_balance | 数值 | 结余前港币结余 |
| profit | 数值 | 本次利润 |
| other_expenses_total | 数值 | 其他支出总额 |
| new_capital | 数值 | 结余后本金 |
| new_hkd_balance | 数值 | 结余后港币结余 |
| settlement_rate | 数值 | 结余汇率 |
| rmb_balance_total | 数值 | 人民币余额汇总 |
| created_at | 时间戳 | 结余时间 |

### 4.5 其他支出明细表（settlement_expenses）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | 主键 | 支出明细ID |
| settlement_id | 外键 | 所属结余ID |
| item_name | 字符串 | 支出项目名称 |
| amount | 数值 | 支出金额 |
| created_at | 时间戳 | 创建时间 |

---

## 五、核心业务规则

### 5.1 交易规则
1. 每笔交易必须关联一个渠道
2. 汇率 = 人民币金额 ÷ 港币金额（自动计算）
3. 入账：渠道人民币余额增加
4. 出账：渠道人民币余额减少

### 5.2 结余规则
1. 结余仅处理状态为"未结余"的交易
2. 结余后，相关交易状态更新为"已结余"
3. 系统本金更新为"结余后本金"（本金 + 利润 - 其他支出）
4. 港币结余更新为"结余后港币结余"（港币结余 + 利润）
5. 其他支出明细需要保存到数据库，关联到结余记录
6. 所有计算结果保留至小数点后3位

### 5.3 数据一致性
1. 渠道余额 = 所有入账人民币之和 - 所有出账人民币之和
2. 每次结余后创建结余记录，交易关联到结余批次
3. 已结余的交易不可修改和删除

---

## 六、功能模块

### 6.1 交易管理
- 新增入账交易
- 新增出账交易
- 查看交易列表（筛选：渠道、类型、结余状态、时间范围）
- 查看交易详情

### 6.2 渠道管理
- 新增渠道
- 编辑渠道
- 查看渠道列表及余额

### 6.3 结余管理
- 结余预览（显示本金、港币结余、利润、汇率、人民币余额等）
- 填写其他支出（支持多项支出，每项包含项目名称和金额）
- 执行结余操作
- 结余后详情页（展示结余前后对比、利润、其他支出明细等）
- 结余历史记录查看

### 6.4 系统设置
- 设置/修改本金
- 设置/修改港币结余
- 设置/修改人民币结余
- 查看系统状态

---

## 七、计算示例

### 示例场景：
**初始状态**：
- 本金：1,000,000 HKD
- 港币结余：526,315 HKD
- 人民币结余：500,000 CNY（各渠道余额汇总）

**交易记录**（所有交易状态均为"未结余"）：
1. 入账：收入 CNY 9,500，价值 HKD 10,000，汇率 0.950
2. 入账：收入 CNY 19,000，价值 HKD 20,000，汇率 0.950
3. 出账：支出 CNY 14,250，价值 HKD 15,000，汇率 0.950

**渠道状态**（结余前）：
- 渠道A人民币余额：514,250 CNY
  - 计算：500,000（初始余额）+ 9,500（入账1）+ 19,000（入账2）- 14,250（出账3）= 514,250 CNY

**结余计算**：

1. **当前结余汇率**：
   ```
   人民币总量 = 514,250（渠道余额汇总）+ 28,500（未结余入账CNY：9,500+19,000）= 542,750 CNY
   港币总量 = 526,315（港币结余）+ 30,000（未结余入账HKD：10,000+20,000）= 556,315 HKD
   当前结余汇率 = 542,750 ÷ 556,315 ≈ 0.976（保留三位小数）
   ```
   > **说明**：人民币总量中的"渠道余额汇总"已经包含了所有交易（入账+出账）的影响，
   > 但为了计算当前的整体汇率，需要加上"未结余入账"交易的港币价值。

2. **利润**：
   ```
   出账港币总额 = 15,000 HKD（出账交易的港币价值）
   出账港币成本 = 14,250（出账CNY）÷ 0.976（当前结余汇率）≈ 14,600 HKD（四舍五入，保留整数）
   利润 = 15,000 - 14,600 = 400 HKD
   ```
   > **说明**：利润 = 出账时收到的港币 - 出账人民币按当前结余汇率计算的成本

3. **结余后本金**（假设其他支出总额为 300 HKD）：
   ```
   其他支出明细：
   - 薪金：100 HKD
   - 金流费用：200 HKD
   - 总支出：300 HKD
   
   结余后本金 = 1,000,000（当前本金）+ 400（利润）- 300（其他支出）= 1,000,100 HKD
   ```

4. **结余后港币结余**：
   ```
   结余后港币结余 = 526,315（当前港币结余）+ 400（利润）= 526,715 HKD
   ```

**结余后状态更新**：
- 本金：1,000,100 HKD（更新全局设置）
- 港币结余：526,715 HKD（更新全局设置）
- 所有未结余交易状态更新为"已结余"
- 创建结余记录，保存所有计算结果和其他支出明细

---

## 八、技术实现建议

### 8.1 前端
- 交易录入界面（表单验证）
- 结余预览弹窗（实时计算）
- 数据可视化（Dashboard）

### 8.2 后端
- RESTful API 设计
- 事务处理（确保数据一致性）
- 计算逻辑封装成服务类

### 8.3 数据库
- 使用数据库事务保证结余操作的原子性
- 添加索引优化查询性能
- 软删除机制保护历史数据

---

## 九、结余页面展示要求

根据参考表格，结余后需要展示完整的结余报表，包括：

### 9.1 顺序标题栏
- 显示本次结余的顺序编号（第几次结余）

### 9.2 核心数据展示
- **本金**：结余前本金
- **利润**：本次结余计算的利润
- **支出**：其他支出总额
- **结余本金**：结余后本金（本金+利润-支出）
- **结余汇率**：当前结余汇率

### 9.3 其他支出明细表
以表格形式展示所有其他支出项目：

| 支出项目 | 金额 |
|---------|------|
| 资金 | 金额 |
| 薪金 | 100 |
| 金流费用 | 200 |
| 旺金 | 金额 |
| 电费 | 金额 |
| 化红 | 金额 |
| **总支出** | **300** |

### 9.4 界面布局参考
```
┌─────────────────────────────────────┐
│  收入支出表          顺序: #1       │
├─────────────────────────────────────┤
│  本金: 3000    利润: 0              │
│  总收入: 3000  总支出: 300          │
│  结余利润: 2700                     │
├─────────────────────────────────────┤
│  其他支出明细:                      │
│  ├─ 资金:      金额                │
│  ├─ 薪金:      100                 │
│  ├─ 金流费用:  200                 │
│  └─ 总支出:    300                 │
└─────────────────────────────────────┘
```

---

## 十、待补充功能

### 10.1 即时买断功能
- **优先级**：低
- **状态**：待设计
- **说明**：待入账、出账功能完善后再补充详细设计

### 10.2 权限管理
- **待确认**：是否需要多用户、多角色权限管理

---

**文档版本**：v2.0  
**创建日期**：2025-10-23  
**最后更新**：2025-10-23

